{
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjp7ImlkIjoiMTAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAxIiwibmFtZSI6ImFkbWluQHRlc3QuY29tIiwiZW1haWwiOiJhZG1pbkB0ZXN0LmNvbSIsInByb2ZpbGVfaWQiOiJzeXN0ZW1fYWRtaW4ifSwiZXhwIjoxNzY2ODg0NTM1LCJpYXQiOjE3NjY3OTgxMzUsImp0aSI6ImZjMzYxZWJhLTlhNjYtNDA2OC1iYjIwLWIzYzU3YTI2MjcxOCJ9.Gokfk1UWaYYEiLUyQhPISuT6Lm-jD8Mks4iui_x6BNg": {
    "items": {}
  },
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjp7ImlkIjoiMTAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAxIiwibmFtZSI6ImFkbWluQHRlc3QuY29tIiwiZW1haWwiOiJhZG1pbkB0ZXN0LmNvbSIsInByb2ZpbGVfaWQiOiJzeXN0ZW1fYWRtaW4ifSwiZXhwIjoxNzY2ODg3MTMyLCJpYXQiOjE3NjY4MDA3MzIsImp0aSI6ImMzMzhlNzhkLTNmODEtNDlhYy05ZTI0LTdlOTZkNzZmOGY2ZiJ9.kOfErpBZynhZ8IBrL0J9XvKSDjOO_9BODB4i3P72MQ0": {
    "items": {
      "/Users/qiliu/projects/nexuscrm/frontend/src/components/AIAssistant.tsx": {
        "path": "/Users/qiliu/projects/nexuscrm/frontend/src/components/AIAssistant.tsx",
        "content": "\nimport React, { useState, useRef, useEffect, useCallback } from 'react';\nimport { agentApi, ChatMessage, StreamEvent } from '../infrastructure/api/agent';\nimport { X, Sparkles, ChevronDown, ChevronRight, Database } from 'lucide-react';\nimport { ProcessStep, ToolBlock, DisplayItem } from './ai/types';\nimport { ToolExecutionSummary } from './ai/ToolExecutionSummary';\nimport { ProcessStepCard } from './ai/ProcessStepCard';\nimport { InputArea } from './ai/InputArea';\nimport { MessageBubble } from './ai/MessageBubble';\nimport { StreamingContent } from './ai/StreamingContent';\nimport { ContextPanel } from './ai/ContextPanel';\nimport { formatToolName, buildDisplayItems } from './ai/utils';\n\nexport interface AIAssistantProps {\n  isOpen: boolean;\n  onClose: () =\u003e void;\n}\n\nexport function AIAssistant({ isOpen, onClose }: AIAssistantProps) {\n  const [messages, setMessages] = useState\u003cChatMessage[]\u003e([]);\n  const [input, setInput] = useState('');\n  const [isLoading, setIsLoading] = useState(false);\n  const [processSteps, setProcessSteps] = useState\u003cProcessStep[]\u003e([]);\n  const [isProcessExpanded, setIsProcessExpanded] = useState(true);\n  const [streamingContent, setStreamingContent] = useState\u003cstring\u003e('');\n  const [panelWidth, setPanelWidth] = useState(520);\n  const [isContextPanelOpen, setIsContextPanelOpen] = useState(false);\n\n  // Context State\n  const [activeFiles, setActiveFiles] = useState\u003c{ path: string, tokenSize: number }[]\u003e([]);\n  const [totalTokens, setTotalTokens] = useState(0);\n\n  const messagesEndRef = useRef\u003cHTMLDivElement\u003e(null);\n  const abortControllerRef = useRef\u003cAbortController | null\u003e(null);\n  const isResizingRef = useRef(false);\n\n  // Poll fetch context occasionally or after commands\n  const fetchContext = async () =\u003e {\n    // We can't actually call mcp tools directly easily from here without a backend endpoint wrapper \n    // mocking the agent calling it. \n    // For now, we'll map the active files from memory if we store them, \n    // OR we can use the slash command /list hidden execution to populate this.\n    // But for this UI implementation, let's trigger a hidden /list command when panel opens\n    // OR better: Assume the agent sends context updates.\n    // Since we don't have a direct \"get context\" API yet (it's an MCP tool), \n    // we'll rely on the agent's response to /list to populate this, OR\n    // we need to add a dedicated REST endpoint for context.\n    // Let's go with the dedicated REST endpoint approach as next step. \n    // For now, we'll keep it empty or mock it until that endpoint exists.\n    // Actually, we can use the /mcp endpoint if we expose it? No.\n    // We will parse the output of /list if the user runs it.\n  };\n\n  // Handle panel resize\n  const handleResizeStart = useCallback((e: React.MouseEvent) =\u003e {\n    e.preventDefault();\n    isResizingRef.current = true;\n    const startX = e.clientX;\n    const startWidth = panelWidth;\n\n    const handleMouseMove = (moveEvent: MouseEvent) =\u003e {\n      if (!isResizingRef.current) return;\n      const delta = startX - moveEvent.clientX;\n      const newWidth = Math.min(Math.max(startWidth + delta, 360), window.innerWidth - 100);\n      setPanelWidth(newWidth);\n    };\n\n    const handleMouseUp = () =\u003e {\n      isResizingRef.current = false;\n      document.removeEventListener('mousemove', handleMouseMove);\n      document.removeEventListener('mouseup', handleMouseUp);\n      document.body.style.cursor = '';\n      document.body.style.userSelect = '';\n    };\n\n    document.addEventListener('mousemove', handleMouseMove);\n    document.addEventListener('mouseup', handleMouseUp);\n    document.body.style.cursor = 'ew-resize';\n    document.body.style.userSelect = 'none';\n  }, [panelWidth]);\n\n  const scrollToBottom = () =\u003e {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  };\n\n  useEffect(() =\u003e {\n    scrollToBottom();\n  }, [messages, isLoading, processSteps, streamingContent]);\n\n  // Effect to parse context list from messages (Simple heuristic)\n  useEffect(() =\u003e {\n    // Look for tool results from context_list\n    const lastMsg = messages[messages.length - 1];\n    if (lastMsg \u0026\u0026 lastMsg.role === 'tool' \u0026\u0026 lastMsg.name === 'context_list') {\n      // Parse logic would go here if we wanted to auto-update\n    }\n  }, [messages]);\n\n  const handleStreamEvent = useCallback((event: StreamEvent) =\u003e {\n    const stepId = `step-${Date.now()}-${Math.random()}`;\n\n    switch (event.type) {\n      case 'thinking':\n        setProcessSteps(prev =\u003e [\n          ...prev.filter(s =\u003e s.type !== 'thinking'), // Replace previous thinking\n          {\n            id: stepId,\n            type: 'thinking',\n            content: event.content || 'Thinking...',\n            timestamp: new Date()\n          }\n        ]);\n        break;\n\n      case 'tool_call':\n        setProcessSteps(prev =\u003e [\n          ...prev.filter(s =\u003e s.type !== 'thinking'), // Clear thinking when tool starts\n          {\n            id: stepId,\n            type: 'tool_call',\n            content: `Calling ${event.tool_name}`,\n            toolName: event.tool_name,\n            toolArgs: event.tool_args,\n            timestamp: new Date()\n          }\n        ]);\n        break;\n\n      case 'tool_result':\n        setProcessSteps(prev =\u003e {\n          // Find last matching tool_call for this tool name\n          let lastMatchingIndex = -1;\n          for (let i = prev.length - 1; i \u003e= 0; i--) {\n            if (prev[i].toolName === event.tool_name \u0026\u0026 prev[i].type === 'tool_call') {\n              lastMatchingIndex = i;\n              break;\n            }\n          }\n          if (lastMatchingIndex === -1) return prev;\n\n          // Capture context list update if applicable\n          if (event.tool_name === 'context_list' \u0026\u0026 !event.is_error \u0026\u0026 event.tool_result) {\n            const result = event.tool_result;\n            // Parse heuristics: \"Active Context (1 files, ~50 tokens): ... - /path (~10 tokens)\"\n            const regex = /- (.*?) \\(~(\\d+) tokens\\)/g;\n            let match;\n            const newFiles = [];\n            let newTotal = 0;\n            while ((match = regex.exec(result)) !== null) {\n              const tokenSize = parseInt(match[2], 10);\n              newFiles.push({ path: match[1], tokenSize });\n              newTotal += tokenSize;\n            }\n            if (newFiles.length \u003e 0 || result.includes(\"0 files\")) {\n              setActiveFiles(newFiles);\n              setTotalTokens(newTotal);\n            }\n          }\n\n          return prev.map((s, idx) =\u003e\n            idx === lastMatchingIndex\n              ? {\n                ...s,\n                type: 'tool_result' as const,\n                toolResult: event.tool_result,\n                isError: event.is_error,\n                content: event.is_error\n                  ? `${event.tool_name} failed`\n                  : `${event.tool_name} completed`\n              }\n              : s\n          );\n        });\n        break;\n\n      case 'content':\n        setProcessSteps(prev =\u003e prev.filter(s =\u003e s.type !== 'thinking'));\n        setStreamingContent(prev =\u003e prev + (event.content || ''));\n        break;\n\n      case 'done':\n        setIsLoading(false);\n        if (event.history) {\n          setMessages(event.history);\n        }\n        setStreamingContent('');\n        setProcessSteps([]);\n        setIsProcessExpanded(false);\n        break;\n\n      case 'error':\n        setIsLoading(false);\n        setMessages(prev =\u003e [\n          ...prev,\n          { role: 'assistant', content: `Error: ${event.content}` }\n        ]);\n        setStreamingContent('');\n        setProcessSteps([]);\n        break;\n    }\n  }, []);\n\n  const handleSubmit = async (e: React.FormEvent) =\u003e {\n    e.preventDefault();\n    if (!input.trim() || isLoading) return;\n\n    // Handle Slash Commands\n    const command = input.trim();\n    if (command.startsWith('/')) {\n      const [cmd, ...args] = command.split(' ');\n\n      if (cmd === '/clear') {\n        setMessages([]);\n        setProcessSteps([]);\n        setStreamingContent('');\n        setInput('');\n        return;\n      }\n\n      // Map other commands to natural language prompts\n      let processedInput = input;\n      if (cmd === '/add') {\n        processedInput = `Please add these files to the context: ${args.join(' ')}. Use the context_add tool. After adding, please list the context.`;\n      } else if (cmd === '/remove') {\n        processedInput = `Please remove these files from the context: ${args.join(' ')}. Use the context_remove tool. After removing, please list the context.`;\n      } else if (cmd === '/list') {\n        processedInput = `Please list the files currently in the context using context_list.`;\n      } else if (cmd === '/help') {\n        setMessages(prev =\u003e [...prev, {\n          role: 'user', content: command\n        }, {\n          role: 'assistant', content: `**Available Commands:**\n- \\`/add \u003cfile\u003e\\`: Add files to context\n- \\`/remove \u003cfile\u003e\\`: Remove files from context\n- \\`/list\\`: List active files\n- \\`/clear\\`: Clear chat history (UI only)\n- \\`/help\\`: Show this help`\n        }]);\n        setInput('');\n        return;\n      }\n\n      const userMsg: ChatMessage = { role: 'user', content: processedInput };\n      const newHistory = [...messages, userMsg];\n\n      setMessages(newHistory);\n      setInput('');\n      setIsLoading(true);\n      setProcessSteps([]);\n      setStreamingContent('');\n      setIsProcessExpanded(true);\n\n      abortControllerRef.current = agentApi.chatStream(\n        { messages: newHistory },\n        handleStreamEvent,\n        (error) =\u003e {\n          console.error('Stream error:', error);\n          setIsLoading(false);\n          setMessages(prev =\u003e [\n            ...prev,\n            { role: 'assistant', content: `Error: ${error.message}` }\n          ]);\n        },\n        () =\u003e {\n          setIsLoading(false);\n        }\n      );\n      return;\n    }\n\n    const userMsg: ChatMessage = { role: 'user', content: input };\n    const newHistory = [...messages, userMsg];\n\n    setMessages(newHistory);\n    setInput('');\n    setIsLoading(true);\n    setProcessSteps([]);\n    setStreamingContent('');\n    setIsProcessExpanded(true);\n\n    abortControllerRef.current = agentApi.chatStream(\n      { messages: newHistory },\n      handleStreamEvent,\n      (error) =\u003e {\n        console.error('Stream error:', error);\n        setIsLoading(false);\n        setMessages(prev =\u003e [\n          ...prev,\n          { role: 'assistant', content: `Error: ${error.message}` }\n        ]);\n      },\n      () =\u003e {\n        setIsLoading(false);\n      }\n    );\n  };\n\n  const handleCancel = () =\u003e {\n    if (abortControllerRef.current) {\n      abortControllerRef.current.abort();\n      setIsLoading(false);\n      // Keep process steps visible so user can see what happened\n      // Just add a cancelled indicator if there's streaming content\n      if (streamingContent) {\n        setMessages(prev =\u003e [\n          ...prev,\n          { role: 'assistant', content: streamingContent + '\\n\\n*(Cancelled)*' }\n        ]);\n        setStreamingContent('');\n      }\n      setIsProcessExpanded(false);\n    }\n  };\n\n  // Initial context load\n  useEffect(() =\u003e {\n    const loadContext = async () =\u003e {\n      try {\n        const context = await agentApi.getContext();\n        setActiveFiles(context.items.map(item =\u003e ({\n          path: item.path,\n          tokenSize: item.token_size\n        })));\n        setTotalTokens(context.total_tokens);\n      } catch (err) {\n        console.error(\"Failed to load context:\", err);\n      }\n    };\n    loadContext();\n  }, []);\n\n  if (!isOpen) return null;\n\n  return (\n    \u003cdiv\n      className=\"fixed right-0 top-0 h-full bg-white/98 backdrop-blur-xl shadow-2xl border-l border-slate-200/50 flex z-50 animate-fade-in\"\n      style={{ width: isContextPanelOpen ? `${panelWidth + 288}px` : `${panelWidth}px` }}\n    \u003e\n      {/* Context Panel (Left of Chat) */}\n      \u003cContextPanel\n        files={activeFiles}\n        totalTokens={totalTokens}\n        maxTokens={128000} // GPT-4o approx window\n        isOpen={isContextPanelOpen}\n        onClose={() =\u003e setIsContextPanelOpen(false)}\n        onRemoveFile={(path) =\u003e {\n          // Trigger removal via chat\n          setInput(`/remove ${path}`);\n          // Auto submit? Maybe just prefill.\n        }}\n      /\u003e\n\n      {/* Main Chat Area */}\n      \u003cdiv className=\"flex flex-col h-full flex-1 relative border-l border-slate-200\"\u003e\n\n        {/* Resize Handle */}\n        \u003cdiv\n          onMouseDown={handleResizeStart}\n          className=\"absolute left-0 top-0 h-full w-2 cursor-ew-resize hover:bg-indigo-500/20 transition-colors z-10 group -ml-1\"\n        \u003e\n          \u003cdiv className=\"absolute left-0 top-1/2 -translate-y-1/2 w-1 h-12 bg-slate-300 rounded-full opacity-0 group-hover:opacity-100 transition-opacity\" /\u003e\n        \u003c/div\u003e\n\n        {/* Header */}\n        \u003cdiv className=\"flex items-center justify-between p-4 border-b border-slate-100 bg-gradient-to-r from-indigo-50 via-purple-50 to-pink-50\"\u003e\n          \u003cdiv className=\"flex items-center gap-3\"\u003e\n            \u003cdiv className=\"bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 p-2.5 rounded-xl shadow-lg shadow-purple-500/25\"\u003e\n              \u003cSparkles size={22} className=\"text-white\" /\u003e\n            \u003c/div\u003e\n            \u003cdiv\u003e\n              \u003ch3 className=\"font-semibold text-slate-800\"\u003eNexus AI\u003c/h3\u003e\n              \u003cp className=\"text-xs text-slate-500\"\u003ePowered by MCP ‚Ä¢ Streaming\u003c/p\u003e\n            \u003c/div\u003e\n          \u003c/div\u003e\n          \u003cdiv className=\"flex gap-2\"\u003e\n            \u003cbutton\n              onClick={() =\u003e setIsContextPanelOpen(!isContextPanelOpen)}\n              className={`p-2 rounded-lg transition-all ${isContextPanelOpen ? 'bg-indigo-100 text-indigo-600' : 'hover:bg-white/80 text-slate-400 hover:text-slate-600'}`}\n              title=\"Toggle Context Panel\"\n            \u003e\n              \u003cDatabase size={20} /\u003e\n            \u003c/button\u003e\n            \u003cbutton\n              onClick={onClose}\n              className=\"p-2 hover:bg-white/80 rounded-full transition-all text-slate-400 hover:text-slate-600\"\n            \u003e\n              \u003cX size={20} /\u003e\n            \u003c/button\u003e\n          \u003c/div\u003e\n        \u003c/div\u003e\n\n        {/* Messages */}\n        \u003cdiv className=\"flex-1 overflow-y-auto p-4 space-y-4 bg-gradient-to-b from-slate-50/50 to-white\"\u003e\n          {buildDisplayItems(messages).map((item, idx) =\u003e {\n            // Render Tool Block\n            if ('type' in item \u0026\u0026 item.type === 'tool_block') {\n              return \u003cToolExecutionSummary key={item.id} block={item as ToolBlock} formatToolName={formatToolName} /\u003e;\n            }\n\n            // Render Chat Message\n            const msg = item as ChatMessage;\n            return \u003cMessageBubble key={`msg-${idx}`} msg={msg} /\u003e;\n          })}\n\n          {/* Process Steps - Collapsible */}\n          {processSteps.length \u003e 0 \u0026\u0026 (\n            \u003cdiv className=\"ml-12 space-y-2\"\u003e\n              \u003cbutton\n                onClick={() =\u003e setIsProcessExpanded(!isProcessExpanded)}\n                className=\"flex items-center gap-2 text-xs text-slate-500 hover:text-slate-700 transition-colors\"\n              \u003e\n                {isProcessExpanded ? \u003cChevronDown size={14} /\u003e : \u003cChevronRight size={14} /\u003e}\n                \u003cspan className=\"font-medium\"\u003e\n                  {isLoading ? 'Processing...' : `${processSteps.length} step${processSteps.length \u003e 1 ? 's' : ''}`}\n                \u003c/span\u003e\n              \u003c/button\u003e\n\n              {isProcessExpanded \u0026\u0026 (\n                \u003cdiv className=\"space-y-2 pl-2 border-l-2 border-slate-200\"\u003e\n                  {processSteps.map((step) =\u003e (\n                    \u003cProcessStepCard key={step.id} step={step} formatToolName={formatToolName} /\u003e\n                  ))}\n                \u003c/div\u003e\n              )}\n            \u003c/div\u003e\n          )}\n\n          {/* Streaming Content */}\n          \u003cStreamingContent content={streamingContent} /\u003e\n\n          \u003cdiv ref={messagesEndRef} /\u003e\n        \u003c/div\u003e\n\n        {/* Input */}\n        \u003cInputArea\n          input={input}\n          isLoading={isLoading}\n          setInput={setInput}\n          handleSubmit={handleSubmit}\n          handleCancel={handleCancel}\n        /\u003e\n      \u003c/div\u003e\n    \u003c/div\u003e\n  );\n}\n",
        "token_size": 4019
      }
    }
  },
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjp7ImlkIjoiMTAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAxIiwibmFtZSI6ImFkbWluQHRlc3QuY29tIiwiZW1haWwiOiJhZG1pbkB0ZXN0LmNvbSIsInByb2ZpbGVfaWQiOiJzeXN0ZW1fYWRtaW4ifSwiZXhwIjoxNzY2ODgyNzE2LCJpYXQiOjE3NjY3OTYzMTYsImp0aSI6IjIzYTQ1MTc4LWQ4MWEtNGJlNi05Nzc5LTQzZWE4MWYyNGNmOSJ9.dHlFcz5x4AInHhQrEU4bwPbcb0reHDqmT77jHNwwNJo": {
    "items": {
      "/Users/qiliu/projects/nexuscrm/backend/cmd/server/main.go": {
        "path": "/Users/qiliu/projects/nexuscrm/backend/cmd/server/main.go",
        "content": "package main\n\nimport (\n\t\"context\"\n\t\"log\"\n\t\"net/http\"\n\t_ \"net/http/pprof\"\n\t\"os\"\n\n\t\"github.com/gin-gonic/gin\"\n\t\"github.com/nexuscrm/backend/internal/application/services\"\n\t\"github.com/nexuscrm/backend/internal/bootstrap\"\n\t\"github.com/nexuscrm/backend/internal/infrastructure/database\"\n\t\"github.com/nexuscrm/backend/internal/interfaces/middleware\"\n\t\"github.com/nexuscrm/backend/internal/interfaces/rest\"\n\t\"github.com/nexuscrm/mcp/pkg/client\"\n\t\"github.com/nexuscrm/mcp/pkg/contextstore\"\n\t\"github.com/nexuscrm/mcp/pkg/mcp\"\n\tmcp_models \"github.com/nexuscrm/mcp/pkg/models\"\n\t\"github.com/nexuscrm/mcp/pkg/server\"\n\tmcp_server \"github.com/nexuscrm/mcp/pkg/server\"\n)\n\nfunc main() {\n\t// Get port from environment\n\tport := os.Getenv(\"PORT\")\n\tif port == \"\" {\n\t\tport = \"3001\" // Default to 3001 (standard NexusCRM port)\n\t}\n\n\t// Initialize database connection\n\tdb, err := database.GetInstance()\n\tif err != nil {\n\t\tlog.Fatalf(\"Failed to connect to database: %v\", err)\n\t}\n\tlog.Println(\"‚úÖ Database connection established\")\n\n\t// Initialize core schema - SchemaManager auto-registers all tables in _System_Table during creation\n\tif err := bootstrap.InitializeSchema(db); err != nil {\n\t\tlog.Fatalf(\"Failed to initialize schema: %v\", err)\n\t}\n\n\t// Initialize service manager\n\tsvcMgr := services.NewServiceManager(db)\n\tlog.Println(\"üîß Service manager initialized\")\n\n\t// Refresh metadata cache - Load all metadata before running bootstrap scripts\n\tif err := svcMgr.RefreshMetadataCache(); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to refresh metadata cache: %v\", err)\n\t} else {\n\t\tlog.Println(\"üì¶ Metadata cache loaded\")\n\t}\n\n\t// Initialize system data (profiles, admin user, etc.)\n\tif err := bootstrap.InitializeSystemData(svcMgr.System); err != nil {\n\t\tlog.Fatalf(\"Failed to initialize system data: %v\", err)\n\t}\n\n\t// Initialize standard objects - Creates tables and metadata\n\t// SchemaManager auto-registers all objects in _System_Table during creation\n\tif err := bootstrap.InitializeStandardObjects(svcMgr.Metadata); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize standard objects: %v\", err)\n\t}\n\n\t// Initialize standard actions - Ensures Edit/Delete actions exist for core objects\n\tif err := bootstrap.InitializeStandardActions(svcMgr.Metadata); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize standard actions: %v\", err)\n\t}\n\n\t// Initialize default permissions for all profiles\n\tif err := bootstrap.InitializePermissions(svcMgr.Permissions, svcMgr.Metadata); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize permissions: %v\", err)\n\t}\n\n\t// Initialize standard apps and tabs\n\tif err := bootstrap.InitializeApps(svcMgr); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize apps: %v\", err)\n\t}\n\n\t// Initialize standard themes\n\tif err := bootstrap.InitializeThemes(svcMgr); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize themes: %v\", err)\n\t}\n\n\t// Initialize UI components\n\tif err := bootstrap.InitializeUIComponents(svcMgr); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize UI components: %v\", err)\n\t}\n\n\t// Initialize setup pages\n\tif err := bootstrap.InitializeSetupPages(svcMgr); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize setup pages: %v\", err)\n\t}\n\n\t// Initialize flows\n\tif err := bootstrap.InitializeFlows(svcMgr.Metadata); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize flows: %v\", err)\n\t}\n\n\t// Run startup assertions to detect design violations\n\t// By default, violations are fatal (strict mode). Set SKIP_ASSERTIONS=true to skip.\n\tif os.Getenv(\"SKIP_ASSERTIONS\") != \"true\" {\n\t\tif _, err := bootstrap.RunAssertions(db, true); err != nil {\n\t\t\tlog.Fatalf(\"‚ùå Startup assertions failed: %v\", err)\n\t\t}\n\t} else {\n\t\tlog.Println(\"‚ö†Ô∏è  Skipping startup assertions (SKIP_ASSERTIONS=true)\")\n\t}\n\n\t// Create Gin router\n\trouter := gin.Default()\n\n\t// CORS middleware - Allow credentials from any origin\n\trouter.Use(middleware.Cors())\n\n\t// Health check\n\trouter.GET(\"/health\", func(c *gin.Context) {\n\t\tc.JSON(200, gin.H{\n\t\t\t\"status\": \"ok\",\n\t\t\t\"server\": \"golang\",\n\t\t})\n\t})\n\n\t// Debug/pprof endpoints for goroutine debugging\n\t// Access: http://localhost:3001/debug/pprof/\n\t// Goroutine stacks: http://localhost:3001/debug/pprof/goroutine?debug=2\n\tdebug := router.Group(\"/debug/pprof\")\n\t{\n\t\tdebug.GET(\"/\", gin.WrapF(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\t\thttp.Redirect(w, r, \"/debug/pprof/\", http.StatusMovedPermanently)\n\t\t})))\n\t\tdebug.GET(\"/goroutine\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/heap\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/threadcreate\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/block\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/mutex\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/profile\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/trace\", gin.WrapH(http.DefaultServeMux))\n\t}\n\n\t// Initialize handlers\n\tformulaHandler := rest.NewFormulaHandler()\n\tauthHandler := rest.NewAuthHandler(svcMgr)\n\tuserHandler := rest.NewUserHandler(svcMgr) // UserHandler init\n\tmetadataHandler := rest.NewMetadataHandler(svcMgr)\n\tuiHandler := rest.NewUIHandler(svcMgr) // Add UIHandler initialization\n\tdataHandler := rest.NewDataHandler(svcMgr)\n\tactionHandler := rest.NewActionHandler(svcMgr)\n\tflowHandler := rest.NewFlowHandler(svcMgr)\n\tadminHandler := rest.NewAdminHandler(svcMgr)\n\tanalyticsHandler := rest.NewAnalyticsHandler(svcMgr)\n\tfileHandler := rest.NewFileHandler(svcMgr)\n\tapprovalHandler := rest.NewApprovalHandler(svcMgr)\n\tfeedHandler := rest.NewFeedHandler(svcMgr)\n\tnotificationHandler := rest.NewNotificationHandler(svcMgr)\n\t// Initialize Agent Handler (MCP-based)\n\t// Function to extract and map backend user to MCP user\n\tagentUserExtractor := func(c *gin.Context) *mcp_models.UserSession {\n\t\tuser := rest.GetUserFromContext(c)\n\t\tif user == nil {\n\t\t\treturn nil\n\t\t}\n\t\t// Map backend user to MCP user\n\t\temail := \"\"\n\t\tif user.Email != nil {\n\t\t\temail = *user.Email\n\t\t}\n\t\treturn \u0026mcp_models.UserSession{\n\t\t\tID:            user.ID,\n\t\t\tName:          user.Name,\n\t\t\tEmail:         email,\n\t\t\tProfileID:     user.ProfileID,\n\t\t\tIsSystemAdmin: user.IsSuperUser(),\n\t\t}\n\t}\n\t// Initialize MCP Handler\n\t// Decoupled: Create standalone ToolBus using NexusClient\n\tapiBaseURL := \"http://localhost:3001\"\n\tif url := os.Getenv(\"API_BASE_URL\"); url != \"\" {\n\t\tapiBaseURL = url\n\t}\n\tmcpClient := client.NewNexusClient(apiBaseURL)\n\n\t// SHARED Context Store with Persistence\n\t// Use data/context_store.json for persistence (relative to CWD: backend)\n\tpersistencePath := \"data/context_store.json\"\n\tsharedContextStore := contextstore.NewContextStore(persistencePath)\n\n\ttoolBus := server.NewToolBusService(mcpClient, sharedContextStore)\n\tmcpHandler := server.NewHandler(toolBus)\n\n\t// Inject shared store into Agent Handler too\n\tagentHandler := mcp_server.NewAgentHandler(agentUserExtractor, sharedContextStore)\n\n\t// Initialize middleware\n\trequireAuth := middleware.RequireAuth(svcMgr.Auth)\n\trequireSystemAdmin := middleware.RequireSystemAdmin()\n\n\t// MCP Endpoint (Model Context Protocol)\n\t// Supports JSON-RPC 2.0 over HTTP\n\t// 1. Require Auth (Validates Bearer token)\n\t// 2. Propagate User Context (Gin -\u003e Stdlib Context) -\u003e WrapH(mcpHandler)\n\trouter.POST(\"/mcp\", requireAuth, func(c *gin.Context) {\n\t\t// Extract user from Gin context (set by RequireAuth)\n\t\tif user, exists := c.Get(\"user\"); exists {\n\t\t\tctx := c.Request.Context()\n\t\t\t// Inject into standard context\n\t\t\tctx = context.WithValue(ctx, \"user\", user)\n\n\t\t\t// Inject Auth Token (needed for ContextStore)\n\t\t\tauthHeader := c.GetHeader(\"Authorization\")\n\t\t\tif len(authHeader) \u003e 7 \u0026\u0026 authHeader[:7] == \"Bearer \" {\n\t\t\t\ttoken := authHeader[7:]\n\t\t\t\tctx = context.WithValue(ctx, mcp.ContextKeyAuthToken, token)\n\t\t\t}\n\n\t\t\tc.Request = c.Request.WithContext(ctx)\n\t\t}\n\t\t// Forward to standard HTTP handler\n\t\tmcpHandler.ServeHTTP(c.Writer, c.Request)\n\t})\n\n\t// API routes\n\tapi := router.Group(\"/api\")\n\t{\n\t\t// Public Auth routes (no authentication required)\n\t\tauth := api.Group(\"/auth\")\n\t\t{\n\t\t\tauth.POST(\"/login\", authHandler.Login)\n\t\t\tauth.POST(\"/logout\", requireAuth, authHandler.Logout)\n\t\t\tauth.GET(\"/me\", requireAuth, authHandler.GetMe)\n\t\t\tauth.GET(\"/permissions/me\", requireAuth, authHandler.GetMyPermissions)\n\t\t\tauth.POST(\"/change-password\", requireAuth, authHandler.ChangePassword)\n\n\t\t\t// Moved to UserHandler\n\t\t\tauth.POST(\"/register\", requireAuth, requireSystemAdmin, userHandler.Register)\n\t\t\tauth.PUT(\"/users/:id\", requireAuth, requireSystemAdmin, userHandler.UpdateUser)\n\t\t\tauth.DELETE(\"/users/:id\", requireAuth, requireSystemAdmin, userHandler.DeleteUser)\n\t\t\tauth.GET(\"/users\", requireAuth, userHandler.GetUsers)\n\t\t\tauth.GET(\"/profiles\", requireAuth, userHandler.GetProfiles)\n\t\t\tauth.GET(\"/profiles/:id/permissions\", requireAuth, userHandler.GetProfilePermissions)\n\t\t\tauth.PUT(\"/profiles/:id/permissions\", requireAuth, requireSystemAdmin, userHandler.UpdateProfilePermissions)\n\t\t\tauth.GET(\"/profiles/:id/permissions/fields\", requireAuth, userHandler.GetProfileFieldPermissions)\n\t\t\tauth.PUT(\"/profiles/:id/permissions/fields\", requireAuth, requireSystemAdmin, userHandler.UpdateProfileFieldPermissions)\n\n\t\t\t// Permission Set permissions\n\t\t\tauth.POST(\"/permission-sets\", requireAuth, requireSystemAdmin, userHandler.CreatePermissionSet)\n\t\t\tauth.PUT(\"/permission-sets/:id\", requireAuth, requireSystemAdmin, userHandler.UpdatePermissionSet)\n\t\t\tauth.DELETE(\"/permission-sets/:id\", requireAuth, requireSystemAdmin, userHandler.DeletePermissionSet)\n\n\t\t\tauth.GET(\"/permission-sets/:id/permissions\", requireAuth, userHandler.GetPermissionSetPermissions)\n\t\t\tauth.PUT(\"/permission-sets/:id/permissions\", requireAuth, requireSystemAdmin, userHandler.UpdatePermissionSetPermissions)\n\t\t\tauth.GET(\"/permission-sets/:id/permissions/fields\", requireAuth, userHandler.GetPermissionSetFieldPermissions)\n\t\t\tauth.PUT(\"/permission-sets/:id/permissions/fields\", requireAuth, requireSystemAdmin, userHandler.UpdatePermissionSetFieldPermissions)\n\n\t\t\t// Effective Permissions (User)\n\t\t\tauth.GET(\"/users/:id/permissions/effective\", requireAuth, requireSystemAdmin, userHandler.GetUserEffectivePermissions)\n\t\t\tauth.GET(\"/users/:id/permissions/fields/effective\", requireAuth, requireSystemAdmin, userHandler.GetUserEffectiveFieldPermissions)\n\t\t}\n\n\t\t// Protected Formula routes\n\t\tformula := api.Group(\"/formula\")\n\t\tformula.Use(requireAuth)\n\t\t{\n\t\t\tformula.POST(\"/evaluate\", formulaHandler.Evaluate)\n\t\t\tformula.POST(\"/condition\", formulaHandler.EvaluateCondition)\n\t\t\tformula.POST(\"/substitute\", formulaHandler.Substitute)\n\t\t\tformula.POST(\"/validate\", formulaHandler.Validate)\n\t\t\tformula.GET(\"/functions\", formulaHandler.GetFunctions)\n\t\t\tformula.DELETE(\"/cache\", formulaHandler.ClearCache)\n\t\t}\n\n\t\t// Admin routes (system admin only)\n\t\tadmin := api.Group(\"/admin\")\n\t\tadmin.Use(requireAuth, requireSystemAdmin)\n\t\t{\n\t\t\tadmin.GET(\"/tables\", adminHandler.GetTableRegistry)\n\t\t\tadmin.POST(\"/validate-schema\", adminHandler.ValidateSchema)\n\t\t}\n\n\t\t// Protected Metadata routes\n\t\tmetadata := api.Group(\"/metadata\")\n\t\tmetadata.Use(requireAuth)\n\t\t{\n\t\t\tmetadata.GET(\"/apps\", uiHandler.GetApps)\n\t\t\tmetadata.POST(\"/apps\", requireSystemAdmin, uiHandler.CreateApp)\n\t\t\tmetadata.PATCH(\"/apps/:id\", requireSystemAdmin, uiHandler.UpdateApp)\n\t\t\tmetadata.DELETE(\"/apps/:id\", requireSystemAdmin, uiHandler.DeleteApp)\n\n\t\t\tmetadata.GET(\"/themes/active\", uiHandler.GetActiveTheme) // New standard endpoint\n\n\t\t\tmetadata.POST(\"/themes\", requireSystemAdmin, uiHandler.CreateTheme)\n\t\t\tmetadata.PUT(\"/themes/:id/activate\", requireSystemAdmin, uiHandler.ActivateTheme)\n\n\t\t\tmetadata.GET(\"/schemas\", metadataHandler.GetSchemas)\n\t\t\tmetadata.POST(\"/schemas\", requireSystemAdmin, metadataHandler.CreateSchema)\n\t\t\tmetadata.GET(\"/schemas/:apiName\", metadataHandler.GetSchema)\n\t\t\tmetadata.PATCH(\"/schemas/:apiName\", requireSystemAdmin, metadataHandler.UpdateSchema)\n\t\t\tmetadata.DELETE(\"/schemas/:apiName\", requireSystemAdmin, metadataHandler.DeleteSchema)\n\t\t\tmetadata.POST(\"/schemas/:apiName/fields\", requireSystemAdmin, metadataHandler.CreateField)\n\t\t\tmetadata.PATCH(\"/schemas/:apiName/fields/:fieldApiName\", requireSystemAdmin, metadataHandler.UpdateField)\n\t\t\tmetadata.DELETE(\"/schemas/:apiName/fields/:fieldApiName\", requireSystemAdmin, metadataHandler.DeleteField)\n\t\t\tmetadata.GET(\"/layouts/:objectName\", uiHandler.GetLayout)\n\t\t\tmetadata.POST(\"/layouts\", uiHandler.SaveLayout)\n\t\t\tmetadata.DELETE(\"/layouts/:id\", uiHandler.DeleteLayout)\n\t\t\tmetadata.POST(\"/layouts/assign\", uiHandler.AssignLayoutToProfile)\n\t\t\tmetadata.GET(\"/actions/:objectName\", actionHandler.GetActions)\n\t\t\tmetadata.GET(\"/actions\", actionHandler.GetAllActions)\n\t\t\tmetadata.GET(\"/actions/id/:actionId\", actionHandler.GetAction)\n\t\t\tmetadata.POST(\"/actions\", actionHandler.CreateAction)\n\t\t\tmetadata.PATCH(\"/actions/:actionId\", actionHandler.UpdateAction)\n\t\t\tmetadata.DELETE(\"/actions/:actionId\", actionHandler.DeleteAction)\n\n\t\t\t// Dashboards\n\t\t\tmetadata.GET(\"/dashboards\", uiHandler.GetDashboards)\n\t\t\tmetadata.POST(\"/dashboards\", uiHandler.CreateDashboard)\n\t\t\tmetadata.GET(\"/dashboards/:id\", uiHandler.GetDashboard)\n\t\t\tmetadata.PATCH(\"/dashboards/:id\", uiHandler.UpdateDashboard)\n\t\t\tmetadata.DELETE(\"/dashboards/:id\", uiHandler.DeleteDashboard)\n\n\t\t\t// List Views\n\t\t\tmetadata.GET(\"/listviews\", uiHandler.GetListViews)\n\t\t\tmetadata.POST(\"/listviews\", uiHandler.CreateListView)\n\t\t\tmetadata.PATCH(\"/listviews/:id\", uiHandler.UpdateListView)\n\t\t\tmetadata.DELETE(\"/listviews/:id\", uiHandler.DeleteListView)\n\n\t\t\t// Validation Rules\n\t\t\tmetadata.GET(\"/validation-rules\", metadataHandler.GetValidationRules)\n\t\t\tmetadata.POST(\"/validation-rules\", requireSystemAdmin, metadataHandler.CreateValidationRule)\n\t\t\tmetadata.PATCH(\"/validation-rules/:id\", requireSystemAdmin, metadataHandler.UpdateValidationRule)\n\t\t\tmetadata.DELETE(\"/validation-rules/:id\", requireSystemAdmin, metadataHandler.DeleteValidationRule)\n\n\t\t\t// Field Types (includes plugins)\n\t\t\tmetadata.GET(\"/fieldtypes\", metadataHandler.GetFieldTypes)\n\n\t\t\t// Flows\n\t\t\tmetadata.GET(\"/flows\", flowHandler.GetAllFlows)\n\t\t\tmetadata.GET(\"/flows/:flowId\", flowHandler.GetFlow)\n\t\t\tmetadata.POST(\"/flows\", flowHandler.CreateFlow)\n\t\t\tmetadata.PATCH(\"/flows/:flowId\", flowHandler.UpdateFlow)\n\t\t\tmetadata.DELETE(\"/flows/:flowId\", flowHandler.DeleteFlow)\n\t\t}\n\n\t\t// Protected Action routes\n\t\tactions := api.Group(\"/actions\")\n\t\tactions.Use(requireAuth)\n\t\t{\n\t\t\tactions.POST(\"/execute/:actionId\", actionHandler.ExecuteAction)\n\t\t}\n\n\t\t// Protected Flow Execution routes (Auto-Launched Flows)\n\t\tflows := api.Group(\"/flows\")\n\t\tflows.Use(requireAuth)\n\t\t{\n\t\t\tflows.POST(\"/:flowId/execute\", flowHandler.ExecuteFlow)\n\t\t}\n\n\t\t// Protected Data routes\n\t\tdata := api.Group(\"/data\")\n\t\tdata.Use(requireAuth)\n\t\t{\n\t\t\tdata.POST(\"/query\", dataHandler.Query)\n\t\t\tdata.POST(\"/analytics\", dataHandler.RunAnalytics)\n\t\t\tdata.POST(\"/search\", dataHandler.Search)\n\t\t\tdata.GET(\"/recyclebin/items\", dataHandler.GetRecycleBinItems)\n\t\t\tdata.POST(\"/recyclebin/restore/:id\", dataHandler.RestoreFromRecycleBin)\n\t\t\tdata.DELETE(\"/recyclebin/:id\", dataHandler.PurgeFromRecycleBin)\n\t\t\t// Single object search - MUST be before /:objectApiName/:id to avoid conflict\n\t\t\tdata.GET(\"/search/:objectApiName\", dataHandler.SearchSingleObject)\n\t\t\tdata.POST(\"/:objectApiName/calculate\", dataHandler.Calculate)\n\t\t\tdata.GET(\"/:objectApiName/:id\", dataHandler.GetRecord)\n\t\t\tdata.POST(\"/:objectApiName\", dataHandler.CreateRecord)\n\t\t\tdata.PATCH(\"/:objectApiName/:id\", dataHandler.UpdateRecord)\n\t\t\tdata.DELETE(\"/:objectApiName/:id\", dataHandler.DeleteRecord)\n\t\t}\n\t\t// Protected Analytics routes (System Admin Only)\n\t\tanalytics := api.Group(\"/analytics\")\n\t\tanalytics.Use(requireAuth, requireSystemAdmin)\n\t\t{\n\t\t\tanalytics.POST(\"/query\", analyticsHandler.ExecuteAdminQuery)\n\t\t}\n\n\t\t// Protected File routes\n\t\tfiles := api.Group(\"/files\")\n\t\tfiles.Use(requireAuth)\n\t\t{\n\t\t\tfiles.POST(\"/upload\", fileHandler.Upload)\n\t\t}\n\n\t\t// Protected Approval routes\n\t\tapprovals := api.Group(\"/approvals\")\n\t\tapprovals.Use(requireAuth)\n\t\t{\n\t\t\tapprovals.POST(\"/submit\", approvalHandler.Submit)\n\t\t\tapprovals.POST(\"/:workItemId/approve\", approvalHandler.Approve)\n\t\t\tapprovals.POST(\"/:workItemId/reject\", approvalHandler.Reject)\n\t\t\tapprovals.GET(\"/pending\", approvalHandler.GetPending)\n\t\t\tapprovals.GET(\"/check/:objectApiName\", approvalHandler.CheckProcess)\n\t\t\tapprovals.GET(\"/history/:objectApiName/:recordId\", approvalHandler.GetHistory)\n\t\t\tapprovals.GET(\"/flow-progress/:instanceId\", approvalHandler.GetFlowProgress)\n\t\t}\n\n\t\t// Protected Feed routes\n\t\tfeed := api.Group(\"/feed\")\n\t\tfeed.Use(requireAuth)\n\t\t{\n\t\t\tfeed.POST(\"/comments\", feedHandler.CreateComment)\n\t\t\tfeed.GET(\"/:recordId\", feedHandler.GetComments)\n\t\t}\n\n\t\t// Protected Notification routes\n\t\tnotifications := api.Group(\"/notifications\")\n\t\tnotifications.Use(requireAuth)\n\t\t{\n\t\t\tnotifications.GET(\"/\", notificationHandler.GetNotifications)\n\t\t\tnotifications.POST(\"/:id/read\", notificationHandler.MarkAsRead)\n\t\t}\n\n\t\t// Protected Agent routes\n\t\tagent := api.Group(\"/agent\")\n\t\tagent.Use(requireAuth)\n\t\t{\n\t\t\tagent.POST(\"/chat/stream\", agentHandler.ChatStream)\n\t\t}\n\t}\n\n\t// Static Files\n\trouter.Static(\"/uploads\", \"./uploads\")\n\n\t// Start background workers\n\tsvcMgr.StartOutboxWorker()\n\tlog.Println(\"üì§ Outbox event worker started (500ms polling)\")\n\n\t// Start server\n\tlog.Println(\"\\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\")\n\tlog.Println(\"üöÄ NexusCRM Golang Backend Started Successfully\")\n\tlog.Println(\"‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\")\n\tlog.Printf(\"\\nüìç Server:         http://localhost:%s\", port)\n\tlog.Printf(\"üîê Auth API:       http://localhost:%s/api/auth\", port)\n\tlog.Printf(\"üìê Formula API:    http://localhost:%s/api/formula\", port)\n\tlog.Printf(\"üìä Metadata API:   http://localhost:%s/api/metadata\", port)\n\tlog.Printf(\"ü§ñ MCP Endpoint:   http://localhost:%s/mcp\", port)\n\tlog.Printf(\"üíæ Data API:       http://localhost:%s/api/data\", port)\n\tlog.Printf(\"üíö Health check:   http://localhost:%s/health\\n\", port)\n\n\tif err := router.Run(\"0.0.0.0:\" + port); err != nil {\n\t\tlog.Fatalf(\"Failed to start server: %v\", err)\n\t}\n}\n",
        "token_size": 4579
      }
    }
  },
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjp7ImlkIjoiMTAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAxIiwibmFtZSI6ImFkbWluQHRlc3QuY29tIiwiZW1haWwiOiJhZG1pbkB0ZXN0LmNvbSIsInByb2ZpbGVfaWQiOiJzeXN0ZW1fYWRtaW4ifSwiZXhwIjoxNzY2ODgyNzM5LCJpYXQiOjE3NjY3OTYzMzksImp0aSI6ImQwMzMyZjBkLTY1YTktNDFlOC04YWI3LWU3OTI0NzY4MGZhMCJ9.VSp19CbwUGrNc6NN1CGfXHUZ_qvR26bc-habUAjLdGQ": {
    "items": {}
  },
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjp7ImlkIjoiMTAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAxIiwibmFtZSI6ImFkbWluQHRlc3QuY29tIiwiZW1haWwiOiJhZG1pbkB0ZXN0LmNvbSIsInByb2ZpbGVfaWQiOiJzeXN0ZW1fYWRtaW4ifSwiZXhwIjoxNzY2ODgyNzUzLCJpYXQiOjE3NjY3OTYzNTMsImp0aSI6ImFjZTQ1MjA4LWZjNzAtNDBmMS1iMDk2LWJmNTY3ZTA3ZDg1OCJ9.K6rmZwvY4Om7r_RHl1HpQ7Di1tSO9XYhMui3YR5fnkU": {
    "items": {
      "/Users/qiliu/projects/nexuscrm/backend/cmd/server/main.go": {
        "path": "/Users/qiliu/projects/nexuscrm/backend/cmd/server/main.go",
        "content": "package main\n\nimport (\n\t\"context\"\n\t\"log\"\n\t\"net/http\"\n\t_ \"net/http/pprof\"\n\t\"os\"\n\n\t\"github.com/gin-gonic/gin\"\n\t\"github.com/nexuscrm/backend/internal/application/services\"\n\t\"github.com/nexuscrm/backend/internal/bootstrap\"\n\t\"github.com/nexuscrm/backend/internal/infrastructure/database\"\n\t\"github.com/nexuscrm/backend/internal/interfaces/middleware\"\n\t\"github.com/nexuscrm/backend/internal/interfaces/rest\"\n\t\"github.com/nexuscrm/mcp/pkg/client\"\n\t\"github.com/nexuscrm/mcp/pkg/contextstore\"\n\t\"github.com/nexuscrm/mcp/pkg/mcp\"\n\tmcp_models \"github.com/nexuscrm/mcp/pkg/models\"\n\t\"github.com/nexuscrm/mcp/pkg/server\"\n\tmcp_server \"github.com/nexuscrm/mcp/pkg/server\"\n)\n\nfunc main() {\n\t// Get port from environment\n\tport := os.Getenv(\"PORT\")\n\tif port == \"\" {\n\t\tport = \"3001\" // Default to 3001 (standard NexusCRM port)\n\t}\n\n\t// Initialize database connection\n\tdb, err := database.GetInstance()\n\tif err != nil {\n\t\tlog.Fatalf(\"Failed to connect to database: %v\", err)\n\t}\n\tlog.Println(\"‚úÖ Database connection established\")\n\n\t// Initialize core schema - SchemaManager auto-registers all tables in _System_Table during creation\n\tif err := bootstrap.InitializeSchema(db); err != nil {\n\t\tlog.Fatalf(\"Failed to initialize schema: %v\", err)\n\t}\n\n\t// Initialize service manager\n\tsvcMgr := services.NewServiceManager(db)\n\tlog.Println(\"üîß Service manager initialized\")\n\n\t// Refresh metadata cache - Load all metadata before running bootstrap scripts\n\tif err := svcMgr.RefreshMetadataCache(); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to refresh metadata cache: %v\", err)\n\t} else {\n\t\tlog.Println(\"üì¶ Metadata cache loaded\")\n\t}\n\n\t// Initialize system data (profiles, admin user, etc.)\n\tif err := bootstrap.InitializeSystemData(svcMgr.System); err != nil {\n\t\tlog.Fatalf(\"Failed to initialize system data: %v\", err)\n\t}\n\n\t// Initialize standard objects - Creates tables and metadata\n\t// SchemaManager auto-registers all objects in _System_Table during creation\n\tif err := bootstrap.InitializeStandardObjects(svcMgr.Metadata); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize standard objects: %v\", err)\n\t}\n\n\t// Initialize standard actions - Ensures Edit/Delete actions exist for core objects\n\tif err := bootstrap.InitializeStandardActions(svcMgr.Metadata); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize standard actions: %v\", err)\n\t}\n\n\t// Initialize default permissions for all profiles\n\tif err := bootstrap.InitializePermissions(svcMgr.Permissions, svcMgr.Metadata); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize permissions: %v\", err)\n\t}\n\n\t// Initialize standard apps and tabs\n\tif err := bootstrap.InitializeApps(svcMgr); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize apps: %v\", err)\n\t}\n\n\t// Initialize standard themes\n\tif err := bootstrap.InitializeThemes(svcMgr); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize themes: %v\", err)\n\t}\n\n\t// Initialize UI components\n\tif err := bootstrap.InitializeUIComponents(svcMgr); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize UI components: %v\", err)\n\t}\n\n\t// Initialize setup pages\n\tif err := bootstrap.InitializeSetupPages(svcMgr); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize setup pages: %v\", err)\n\t}\n\n\t// Initialize flows\n\tif err := bootstrap.InitializeFlows(svcMgr.Metadata); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize flows: %v\", err)\n\t}\n\n\t// Run startup assertions to detect design violations\n\t// By default, violations are fatal (strict mode). Set SKIP_ASSERTIONS=true to skip.\n\tif os.Getenv(\"SKIP_ASSERTIONS\") != \"true\" {\n\t\tif _, err := bootstrap.RunAssertions(db, true); err != nil {\n\t\t\tlog.Fatalf(\"‚ùå Startup assertions failed: %v\", err)\n\t\t}\n\t} else {\n\t\tlog.Println(\"‚ö†Ô∏è  Skipping startup assertions (SKIP_ASSERTIONS=true)\")\n\t}\n\n\t// Create Gin router\n\trouter := gin.Default()\n\n\t// CORS middleware - Allow credentials from any origin\n\trouter.Use(middleware.Cors())\n\n\t// Health check\n\trouter.GET(\"/health\", func(c *gin.Context) {\n\t\tc.JSON(200, gin.H{\n\t\t\t\"status\": \"ok\",\n\t\t\t\"server\": \"golang\",\n\t\t})\n\t})\n\n\t// Debug/pprof endpoints for goroutine debugging\n\t// Access: http://localhost:3001/debug/pprof/\n\t// Goroutine stacks: http://localhost:3001/debug/pprof/goroutine?debug=2\n\tdebug := router.Group(\"/debug/pprof\")\n\t{\n\t\tdebug.GET(\"/\", gin.WrapF(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\t\thttp.Redirect(w, r, \"/debug/pprof/\", http.StatusMovedPermanently)\n\t\t})))\n\t\tdebug.GET(\"/goroutine\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/heap\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/threadcreate\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/block\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/mutex\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/profile\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/trace\", gin.WrapH(http.DefaultServeMux))\n\t}\n\n\t// Initialize handlers\n\tformulaHandler := rest.NewFormulaHandler()\n\tauthHandler := rest.NewAuthHandler(svcMgr)\n\tuserHandler := rest.NewUserHandler(svcMgr) // UserHandler init\n\tmetadataHandler := rest.NewMetadataHandler(svcMgr)\n\tuiHandler := rest.NewUIHandler(svcMgr) // Add UIHandler initialization\n\tdataHandler := rest.NewDataHandler(svcMgr)\n\tactionHandler := rest.NewActionHandler(svcMgr)\n\tflowHandler := rest.NewFlowHandler(svcMgr)\n\tadminHandler := rest.NewAdminHandler(svcMgr)\n\tanalyticsHandler := rest.NewAnalyticsHandler(svcMgr)\n\tfileHandler := rest.NewFileHandler(svcMgr)\n\tapprovalHandler := rest.NewApprovalHandler(svcMgr)\n\tfeedHandler := rest.NewFeedHandler(svcMgr)\n\tnotificationHandler := rest.NewNotificationHandler(svcMgr)\n\t// Initialize Agent Handler (MCP-based)\n\t// Function to extract and map backend user to MCP user\n\tagentUserExtractor := func(c *gin.Context) *mcp_models.UserSession {\n\t\tuser := rest.GetUserFromContext(c)\n\t\tif user == nil {\n\t\t\treturn nil\n\t\t}\n\t\t// Map backend user to MCP user\n\t\temail := \"\"\n\t\tif user.Email != nil {\n\t\t\temail = *user.Email\n\t\t}\n\t\treturn \u0026mcp_models.UserSession{\n\t\t\tID:            user.ID,\n\t\t\tName:          user.Name,\n\t\t\tEmail:         email,\n\t\t\tProfileID:     user.ProfileID,\n\t\t\tIsSystemAdmin: user.IsSuperUser(),\n\t\t}\n\t}\n\t// Initialize MCP Handler\n\t// Decoupled: Create standalone ToolBus using NexusClient\n\tapiBaseURL := \"http://localhost:3001\"\n\tif url := os.Getenv(\"API_BASE_URL\"); url != \"\" {\n\t\tapiBaseURL = url\n\t}\n\tmcpClient := client.NewNexusClient(apiBaseURL)\n\n\t// SHARED Context Store with Persistence\n\t// Use data/context_store.json for persistence (relative to CWD: backend)\n\tpersistencePath := \"data/context_store.json\"\n\tsharedContextStore := contextstore.NewContextStore(persistencePath)\n\n\ttoolBus := server.NewToolBusService(mcpClient, sharedContextStore)\n\tmcpHandler := server.NewHandler(toolBus)\n\n\t// Inject shared store into Agent Handler too\n\tagentHandler := mcp_server.NewAgentHandler(agentUserExtractor, sharedContextStore)\n\n\t// Initialize middleware\n\trequireAuth := middleware.RequireAuth(svcMgr.Auth)\n\trequireSystemAdmin := middleware.RequireSystemAdmin()\n\n\t// MCP Endpoint (Model Context Protocol)\n\t// Supports JSON-RPC 2.0 over HTTP\n\t// 1. Require Auth (Validates Bearer token)\n\t// 2. Propagate User Context (Gin -\u003e Stdlib Context) -\u003e WrapH(mcpHandler)\n\trouter.POST(\"/mcp\", requireAuth, func(c *gin.Context) {\n\t\t// Extract user from Gin context (set by RequireAuth)\n\t\tif user, exists := c.Get(\"user\"); exists {\n\t\t\tctx := c.Request.Context()\n\t\t\t// Inject into standard context\n\t\t\tctx = context.WithValue(ctx, \"user\", user)\n\n\t\t\t// Inject Auth Token (needed for ContextStore)\n\t\t\tauthHeader := c.GetHeader(\"Authorization\")\n\t\t\tif len(authHeader) \u003e 7 \u0026\u0026 authHeader[:7] == \"Bearer \" {\n\t\t\t\ttoken := authHeader[7:]\n\t\t\t\tctx = context.WithValue(ctx, mcp.ContextKeyAuthToken, token)\n\t\t\t}\n\n\t\t\tc.Request = c.Request.WithContext(ctx)\n\t\t}\n\t\t// Forward to standard HTTP handler\n\t\tmcpHandler.ServeHTTP(c.Writer, c.Request)\n\t})\n\n\t// API routes\n\tapi := router.Group(\"/api\")\n\t{\n\t\t// Public Auth routes (no authentication required)\n\t\tauth := api.Group(\"/auth\")\n\t\t{\n\t\t\tauth.POST(\"/login\", authHandler.Login)\n\t\t\tauth.POST(\"/logout\", requireAuth, authHandler.Logout)\n\t\t\tauth.GET(\"/me\", requireAuth, authHandler.GetMe)\n\t\t\tauth.GET(\"/permissions/me\", requireAuth, authHandler.GetMyPermissions)\n\t\t\tauth.POST(\"/change-password\", requireAuth, authHandler.ChangePassword)\n\n\t\t\t// Moved to UserHandler\n\t\t\tauth.POST(\"/register\", requireAuth, requireSystemAdmin, userHandler.Register)\n\t\t\tauth.PUT(\"/users/:id\", requireAuth, requireSystemAdmin, userHandler.UpdateUser)\n\t\t\tauth.DELETE(\"/users/:id\", requireAuth, requireSystemAdmin, userHandler.DeleteUser)\n\t\t\tauth.GET(\"/users\", requireAuth, userHandler.GetUsers)\n\t\t\tauth.GET(\"/profiles\", requireAuth, userHandler.GetProfiles)\n\t\t\tauth.GET(\"/profiles/:id/permissions\", requireAuth, userHandler.GetProfilePermissions)\n\t\t\tauth.PUT(\"/profiles/:id/permissions\", requireAuth, requireSystemAdmin, userHandler.UpdateProfilePermissions)\n\t\t\tauth.GET(\"/profiles/:id/permissions/fields\", requireAuth, userHandler.GetProfileFieldPermissions)\n\t\t\tauth.PUT(\"/profiles/:id/permissions/fields\", requireAuth, requireSystemAdmin, userHandler.UpdateProfileFieldPermissions)\n\n\t\t\t// Permission Set permissions\n\t\t\tauth.POST(\"/permission-sets\", requireAuth, requireSystemAdmin, userHandler.CreatePermissionSet)\n\t\t\tauth.PUT(\"/permission-sets/:id\", requireAuth, requireSystemAdmin, userHandler.UpdatePermissionSet)\n\t\t\tauth.DELETE(\"/permission-sets/:id\", requireAuth, requireSystemAdmin, userHandler.DeletePermissionSet)\n\n\t\t\tauth.GET(\"/permission-sets/:id/permissions\", requireAuth, userHandler.GetPermissionSetPermissions)\n\t\t\tauth.PUT(\"/permission-sets/:id/permissions\", requireAuth, requireSystemAdmin, userHandler.UpdatePermissionSetPermissions)\n\t\t\tauth.GET(\"/permission-sets/:id/permissions/fields\", requireAuth, userHandler.GetPermissionSetFieldPermissions)\n\t\t\tauth.PUT(\"/permission-sets/:id/permissions/fields\", requireAuth, requireSystemAdmin, userHandler.UpdatePermissionSetFieldPermissions)\n\n\t\t\t// Effective Permissions (User)\n\t\t\tauth.GET(\"/users/:id/permissions/effective\", requireAuth, requireSystemAdmin, userHandler.GetUserEffectivePermissions)\n\t\t\tauth.GET(\"/users/:id/permissions/fields/effective\", requireAuth, requireSystemAdmin, userHandler.GetUserEffectiveFieldPermissions)\n\t\t}\n\n\t\t// Protected Formula routes\n\t\tformula := api.Group(\"/formula\")\n\t\tformula.Use(requireAuth)\n\t\t{\n\t\t\tformula.POST(\"/evaluate\", formulaHandler.Evaluate)\n\t\t\tformula.POST(\"/condition\", formulaHandler.EvaluateCondition)\n\t\t\tformula.POST(\"/substitute\", formulaHandler.Substitute)\n\t\t\tformula.POST(\"/validate\", formulaHandler.Validate)\n\t\t\tformula.GET(\"/functions\", formulaHandler.GetFunctions)\n\t\t\tformula.DELETE(\"/cache\", formulaHandler.ClearCache)\n\t\t}\n\n\t\t// Admin routes (system admin only)\n\t\tadmin := api.Group(\"/admin\")\n\t\tadmin.Use(requireAuth, requireSystemAdmin)\n\t\t{\n\t\t\tadmin.GET(\"/tables\", adminHandler.GetTableRegistry)\n\t\t\tadmin.POST(\"/validate-schema\", adminHandler.ValidateSchema)\n\t\t}\n\n\t\t// Protected Metadata routes\n\t\tmetadata := api.Group(\"/metadata\")\n\t\tmetadata.Use(requireAuth)\n\t\t{\n\t\t\tmetadata.GET(\"/apps\", uiHandler.GetApps)\n\t\t\tmetadata.POST(\"/apps\", requireSystemAdmin, uiHandler.CreateApp)\n\t\t\tmetadata.PATCH(\"/apps/:id\", requireSystemAdmin, uiHandler.UpdateApp)\n\t\t\tmetadata.DELETE(\"/apps/:id\", requireSystemAdmin, uiHandler.DeleteApp)\n\n\t\t\tmetadata.GET(\"/themes/active\", uiHandler.GetActiveTheme) // New standard endpoint\n\n\t\t\tmetadata.POST(\"/themes\", requireSystemAdmin, uiHandler.CreateTheme)\n\t\t\tmetadata.PUT(\"/themes/:id/activate\", requireSystemAdmin, uiHandler.ActivateTheme)\n\n\t\t\tmetadata.GET(\"/schemas\", metadataHandler.GetSchemas)\n\t\t\tmetadata.POST(\"/schemas\", requireSystemAdmin, metadataHandler.CreateSchema)\n\t\t\tmetadata.GET(\"/schemas/:apiName\", metadataHandler.GetSchema)\n\t\t\tmetadata.PATCH(\"/schemas/:apiName\", requireSystemAdmin, metadataHandler.UpdateSchema)\n\t\t\tmetadata.DELETE(\"/schemas/:apiName\", requireSystemAdmin, metadataHandler.DeleteSchema)\n\t\t\tmetadata.POST(\"/schemas/:apiName/fields\", requireSystemAdmin, metadataHandler.CreateField)\n\t\t\tmetadata.PATCH(\"/schemas/:apiName/fields/:fieldApiName\", requireSystemAdmin, metadataHandler.UpdateField)\n\t\t\tmetadata.DELETE(\"/schemas/:apiName/fields/:fieldApiName\", requireSystemAdmin, metadataHandler.DeleteField)\n\t\t\tmetadata.GET(\"/layouts/:objectName\", uiHandler.GetLayout)\n\t\t\tmetadata.POST(\"/layouts\", uiHandler.SaveLayout)\n\t\t\tmetadata.DELETE(\"/layouts/:id\", uiHandler.DeleteLayout)\n\t\t\tmetadata.POST(\"/layouts/assign\", uiHandler.AssignLayoutToProfile)\n\t\t\tmetadata.GET(\"/actions/:objectName\", actionHandler.GetActions)\n\t\t\tmetadata.GET(\"/actions\", actionHandler.GetAllActions)\n\t\t\tmetadata.GET(\"/actions/id/:actionId\", actionHandler.GetAction)\n\t\t\tmetadata.POST(\"/actions\", actionHandler.CreateAction)\n\t\t\tmetadata.PATCH(\"/actions/:actionId\", actionHandler.UpdateAction)\n\t\t\tmetadata.DELETE(\"/actions/:actionId\", actionHandler.DeleteAction)\n\n\t\t\t// Dashboards\n\t\t\tmetadata.GET(\"/dashboards\", uiHandler.GetDashboards)\n\t\t\tmetadata.POST(\"/dashboards\", uiHandler.CreateDashboard)\n\t\t\tmetadata.GET(\"/dashboards/:id\", uiHandler.GetDashboard)\n\t\t\tmetadata.PATCH(\"/dashboards/:id\", uiHandler.UpdateDashboard)\n\t\t\tmetadata.DELETE(\"/dashboards/:id\", uiHandler.DeleteDashboard)\n\n\t\t\t// List Views\n\t\t\tmetadata.GET(\"/listviews\", uiHandler.GetListViews)\n\t\t\tmetadata.POST(\"/listviews\", uiHandler.CreateListView)\n\t\t\tmetadata.PATCH(\"/listviews/:id\", uiHandler.UpdateListView)\n\t\t\tmetadata.DELETE(\"/listviews/:id\", uiHandler.DeleteListView)\n\n\t\t\t// Validation Rules\n\t\t\tmetadata.GET(\"/validation-rules\", metadataHandler.GetValidationRules)\n\t\t\tmetadata.POST(\"/validation-rules\", requireSystemAdmin, metadataHandler.CreateValidationRule)\n\t\t\tmetadata.PATCH(\"/validation-rules/:id\", requireSystemAdmin, metadataHandler.UpdateValidationRule)\n\t\t\tmetadata.DELETE(\"/validation-rules/:id\", requireSystemAdmin, metadataHandler.DeleteValidationRule)\n\n\t\t\t// Field Types (includes plugins)\n\t\t\tmetadata.GET(\"/fieldtypes\", metadataHandler.GetFieldTypes)\n\n\t\t\t// Flows\n\t\t\tmetadata.GET(\"/flows\", flowHandler.GetAllFlows)\n\t\t\tmetadata.GET(\"/flows/:flowId\", flowHandler.GetFlow)\n\t\t\tmetadata.POST(\"/flows\", flowHandler.CreateFlow)\n\t\t\tmetadata.PATCH(\"/flows/:flowId\", flowHandler.UpdateFlow)\n\t\t\tmetadata.DELETE(\"/flows/:flowId\", flowHandler.DeleteFlow)\n\t\t}\n\n\t\t// Protected Action routes\n\t\tactions := api.Group(\"/actions\")\n\t\tactions.Use(requireAuth)\n\t\t{\n\t\t\tactions.POST(\"/execute/:actionId\", actionHandler.ExecuteAction)\n\t\t}\n\n\t\t// Protected Flow Execution routes (Auto-Launched Flows)\n\t\tflows := api.Group(\"/flows\")\n\t\tflows.Use(requireAuth)\n\t\t{\n\t\t\tflows.POST(\"/:flowId/execute\", flowHandler.ExecuteFlow)\n\t\t}\n\n\t\t// Protected Data routes\n\t\tdata := api.Group(\"/data\")\n\t\tdata.Use(requireAuth)\n\t\t{\n\t\t\tdata.POST(\"/query\", dataHandler.Query)\n\t\t\tdata.POST(\"/analytics\", dataHandler.RunAnalytics)\n\t\t\tdata.POST(\"/search\", dataHandler.Search)\n\t\t\tdata.GET(\"/recyclebin/items\", dataHandler.GetRecycleBinItems)\n\t\t\tdata.POST(\"/recyclebin/restore/:id\", dataHandler.RestoreFromRecycleBin)\n\t\t\tdata.DELETE(\"/recyclebin/:id\", dataHandler.PurgeFromRecycleBin)\n\t\t\t// Single object search - MUST be before /:objectApiName/:id to avoid conflict\n\t\t\tdata.GET(\"/search/:objectApiName\", dataHandler.SearchSingleObject)\n\t\t\tdata.POST(\"/:objectApiName/calculate\", dataHandler.Calculate)\n\t\t\tdata.GET(\"/:objectApiName/:id\", dataHandler.GetRecord)\n\t\t\tdata.POST(\"/:objectApiName\", dataHandler.CreateRecord)\n\t\t\tdata.PATCH(\"/:objectApiName/:id\", dataHandler.UpdateRecord)\n\t\t\tdata.DELETE(\"/:objectApiName/:id\", dataHandler.DeleteRecord)\n\t\t}\n\t\t// Protected Analytics routes (System Admin Only)\n\t\tanalytics := api.Group(\"/analytics\")\n\t\tanalytics.Use(requireAuth, requireSystemAdmin)\n\t\t{\n\t\t\tanalytics.POST(\"/query\", analyticsHandler.ExecuteAdminQuery)\n\t\t}\n\n\t\t// Protected File routes\n\t\tfiles := api.Group(\"/files\")\n\t\tfiles.Use(requireAuth)\n\t\t{\n\t\t\tfiles.POST(\"/upload\", fileHandler.Upload)\n\t\t}\n\n\t\t// Protected Approval routes\n\t\tapprovals := api.Group(\"/approvals\")\n\t\tapprovals.Use(requireAuth)\n\t\t{\n\t\t\tapprovals.POST(\"/submit\", approvalHandler.Submit)\n\t\t\tapprovals.POST(\"/:workItemId/approve\", approvalHandler.Approve)\n\t\t\tapprovals.POST(\"/:workItemId/reject\", approvalHandler.Reject)\n\t\t\tapprovals.GET(\"/pending\", approvalHandler.GetPending)\n\t\t\tapprovals.GET(\"/check/:objectApiName\", approvalHandler.CheckProcess)\n\t\t\tapprovals.GET(\"/history/:objectApiName/:recordId\", approvalHandler.GetHistory)\n\t\t\tapprovals.GET(\"/flow-progress/:instanceId\", approvalHandler.GetFlowProgress)\n\t\t}\n\n\t\t// Protected Feed routes\n\t\tfeed := api.Group(\"/feed\")\n\t\tfeed.Use(requireAuth)\n\t\t{\n\t\t\tfeed.POST(\"/comments\", feedHandler.CreateComment)\n\t\t\tfeed.GET(\"/:recordId\", feedHandler.GetComments)\n\t\t}\n\n\t\t// Protected Notification routes\n\t\tnotifications := api.Group(\"/notifications\")\n\t\tnotifications.Use(requireAuth)\n\t\t{\n\t\t\tnotifications.GET(\"/\", notificationHandler.GetNotifications)\n\t\t\tnotifications.POST(\"/:id/read\", notificationHandler.MarkAsRead)\n\t\t}\n\n\t\t// Protected Agent routes\n\t\tagent := api.Group(\"/agent\")\n\t\tagent.Use(requireAuth)\n\t\t{\n\t\t\tagent.POST(\"/chat/stream\", agentHandler.ChatStream)\n\t\t}\n\t}\n\n\t// Static Files\n\trouter.Static(\"/uploads\", \"./uploads\")\n\n\t// Start background workers\n\tsvcMgr.StartOutboxWorker()\n\tlog.Println(\"üì§ Outbox event worker started (500ms polling)\")\n\n\t// Start server\n\tlog.Println(\"\\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\")\n\tlog.Println(\"üöÄ NexusCRM Golang Backend Started Successfully\")\n\tlog.Println(\"‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\")\n\tlog.Printf(\"\\nüìç Server:         http://localhost:%s\", port)\n\tlog.Printf(\"üîê Auth API:       http://localhost:%s/api/auth\", port)\n\tlog.Printf(\"üìê Formula API:    http://localhost:%s/api/formula\", port)\n\tlog.Printf(\"üìä Metadata API:   http://localhost:%s/api/metadata\", port)\n\tlog.Printf(\"ü§ñ MCP Endpoint:   http://localhost:%s/mcp\", port)\n\tlog.Printf(\"üíæ Data API:       http://localhost:%s/api/data\", port)\n\tlog.Printf(\"üíö Health check:   http://localhost:%s/health\\n\", port)\n\n\tif err := router.Run(\"0.0.0.0:\" + port); err != nil {\n\t\tlog.Fatalf(\"Failed to start server: %v\", err)\n\t}\n}\n",
        "token_size": 4579
      }
    }
  },
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjp7ImlkIjoiMTAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAxIiwibmFtZSI6ImFkbWluQHRlc3QuY29tIiwiZW1haWwiOiJhZG1pbkB0ZXN0LmNvbSIsInByb2ZpbGVfaWQiOiJzeXN0ZW1fYWRtaW4ifSwiZXhwIjoxNzY2ODgyNzYyLCJpYXQiOjE3NjY3OTYzNjIsImp0aSI6IjIyZjAwN2RjLTQ3NzgtNGY0MC04Mjc4LTY3YzIxYzJjMTZmNyJ9.B1CBs3cTdWanAcTdGF5NnB9ObOuQqlY172oRZ_rrh7c": {
    "items": {
      "/Users/qiliu/projects/nexuscrm/backend/cmd/server/main.go": {
        "path": "/Users/qiliu/projects/nexuscrm/backend/cmd/server/main.go",
        "content": "package main\n\nimport (\n\t\"context\"\n\t\"log\"\n\t\"net/http\"\n\t_ \"net/http/pprof\"\n\t\"os\"\n\n\t\"github.com/gin-gonic/gin\"\n\t\"github.com/nexuscrm/backend/internal/application/services\"\n\t\"github.com/nexuscrm/backend/internal/bootstrap\"\n\t\"github.com/nexuscrm/backend/internal/infrastructure/database\"\n\t\"github.com/nexuscrm/backend/internal/interfaces/middleware\"\n\t\"github.com/nexuscrm/backend/internal/interfaces/rest\"\n\t\"github.com/nexuscrm/mcp/pkg/client\"\n\t\"github.com/nexuscrm/mcp/pkg/contextstore\"\n\t\"github.com/nexuscrm/mcp/pkg/mcp\"\n\tmcp_models \"github.com/nexuscrm/mcp/pkg/models\"\n\t\"github.com/nexuscrm/mcp/pkg/server\"\n\tmcp_server \"github.com/nexuscrm/mcp/pkg/server\"\n)\n\nfunc main() {\n\t// Get port from environment\n\tport := os.Getenv(\"PORT\")\n\tif port == \"\" {\n\t\tport = \"3001\" // Default to 3001 (standard NexusCRM port)\n\t}\n\n\t// Initialize database connection\n\tdb, err := database.GetInstance()\n\tif err != nil {\n\t\tlog.Fatalf(\"Failed to connect to database: %v\", err)\n\t}\n\tlog.Println(\"‚úÖ Database connection established\")\n\n\t// Initialize core schema - SchemaManager auto-registers all tables in _System_Table during creation\n\tif err := bootstrap.InitializeSchema(db); err != nil {\n\t\tlog.Fatalf(\"Failed to initialize schema: %v\", err)\n\t}\n\n\t// Initialize service manager\n\tsvcMgr := services.NewServiceManager(db)\n\tlog.Println(\"üîß Service manager initialized\")\n\n\t// Refresh metadata cache - Load all metadata before running bootstrap scripts\n\tif err := svcMgr.RefreshMetadataCache(); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to refresh metadata cache: %v\", err)\n\t} else {\n\t\tlog.Println(\"üì¶ Metadata cache loaded\")\n\t}\n\n\t// Initialize system data (profiles, admin user, etc.)\n\tif err := bootstrap.InitializeSystemData(svcMgr.System); err != nil {\n\t\tlog.Fatalf(\"Failed to initialize system data: %v\", err)\n\t}\n\n\t// Initialize standard objects - Creates tables and metadata\n\t// SchemaManager auto-registers all objects in _System_Table during creation\n\tif err := bootstrap.InitializeStandardObjects(svcMgr.Metadata); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize standard objects: %v\", err)\n\t}\n\n\t// Initialize standard actions - Ensures Edit/Delete actions exist for core objects\n\tif err := bootstrap.InitializeStandardActions(svcMgr.Metadata); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize standard actions: %v\", err)\n\t}\n\n\t// Initialize default permissions for all profiles\n\tif err := bootstrap.InitializePermissions(svcMgr.Permissions, svcMgr.Metadata); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize permissions: %v\", err)\n\t}\n\n\t// Initialize standard apps and tabs\n\tif err := bootstrap.InitializeApps(svcMgr); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize apps: %v\", err)\n\t}\n\n\t// Initialize standard themes\n\tif err := bootstrap.InitializeThemes(svcMgr); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize themes: %v\", err)\n\t}\n\n\t// Initialize UI components\n\tif err := bootstrap.InitializeUIComponents(svcMgr); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize UI components: %v\", err)\n\t}\n\n\t// Initialize setup pages\n\tif err := bootstrap.InitializeSetupPages(svcMgr); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize setup pages: %v\", err)\n\t}\n\n\t// Initialize flows\n\tif err := bootstrap.InitializeFlows(svcMgr.Metadata); err != nil {\n\t\tlog.Printf(\"‚ö†Ô∏è  Warning: Failed to initialize flows: %v\", err)\n\t}\n\n\t// Run startup assertions to detect design violations\n\t// By default, violations are fatal (strict mode). Set SKIP_ASSERTIONS=true to skip.\n\tif os.Getenv(\"SKIP_ASSERTIONS\") != \"true\" {\n\t\tif _, err := bootstrap.RunAssertions(db, true); err != nil {\n\t\t\tlog.Fatalf(\"‚ùå Startup assertions failed: %v\", err)\n\t\t}\n\t} else {\n\t\tlog.Println(\"‚ö†Ô∏è  Skipping startup assertions (SKIP_ASSERTIONS=true)\")\n\t}\n\n\t// Create Gin router\n\trouter := gin.Default()\n\n\t// CORS middleware - Allow credentials from any origin\n\trouter.Use(middleware.Cors())\n\n\t// Health check\n\trouter.GET(\"/health\", func(c *gin.Context) {\n\t\tc.JSON(200, gin.H{\n\t\t\t\"status\": \"ok\",\n\t\t\t\"server\": \"golang\",\n\t\t})\n\t})\n\n\t// Debug/pprof endpoints for goroutine debugging\n\t// Access: http://localhost:3001/debug/pprof/\n\t// Goroutine stacks: http://localhost:3001/debug/pprof/goroutine?debug=2\n\tdebug := router.Group(\"/debug/pprof\")\n\t{\n\t\tdebug.GET(\"/\", gin.WrapF(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\t\thttp.Redirect(w, r, \"/debug/pprof/\", http.StatusMovedPermanently)\n\t\t})))\n\t\tdebug.GET(\"/goroutine\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/heap\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/threadcreate\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/block\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/mutex\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/profile\", gin.WrapH(http.DefaultServeMux))\n\t\tdebug.GET(\"/trace\", gin.WrapH(http.DefaultServeMux))\n\t}\n\n\t// Initialize handlers\n\tformulaHandler := rest.NewFormulaHandler()\n\tauthHandler := rest.NewAuthHandler(svcMgr)\n\tuserHandler := rest.NewUserHandler(svcMgr) // UserHandler init\n\tmetadataHandler := rest.NewMetadataHandler(svcMgr)\n\tuiHandler := rest.NewUIHandler(svcMgr) // Add UIHandler initialization\n\tdataHandler := rest.NewDataHandler(svcMgr)\n\tactionHandler := rest.NewActionHandler(svcMgr)\n\tflowHandler := rest.NewFlowHandler(svcMgr)\n\tadminHandler := rest.NewAdminHandler(svcMgr)\n\tanalyticsHandler := rest.NewAnalyticsHandler(svcMgr)\n\tfileHandler := rest.NewFileHandler(svcMgr)\n\tapprovalHandler := rest.NewApprovalHandler(svcMgr)\n\tfeedHandler := rest.NewFeedHandler(svcMgr)\n\tnotificationHandler := rest.NewNotificationHandler(svcMgr)\n\t// Initialize Agent Handler (MCP-based)\n\t// Function to extract and map backend user to MCP user\n\tagentUserExtractor := func(c *gin.Context) *mcp_models.UserSession {\n\t\tuser := rest.GetUserFromContext(c)\n\t\tif user == nil {\n\t\t\treturn nil\n\t\t}\n\t\t// Map backend user to MCP user\n\t\temail := \"\"\n\t\tif user.Email != nil {\n\t\t\temail = *user.Email\n\t\t}\n\t\treturn \u0026mcp_models.UserSession{\n\t\t\tID:            user.ID,\n\t\t\tName:          user.Name,\n\t\t\tEmail:         email,\n\t\t\tProfileID:     user.ProfileID,\n\t\t\tIsSystemAdmin: user.IsSuperUser(),\n\t\t}\n\t}\n\t// Initialize MCP Handler\n\t// Decoupled: Create standalone ToolBus using NexusClient\n\tapiBaseURL := \"http://localhost:3001\"\n\tif url := os.Getenv(\"API_BASE_URL\"); url != \"\" {\n\t\tapiBaseURL = url\n\t}\n\tmcpClient := client.NewNexusClient(apiBaseURL)\n\n\t// SHARED Context Store with Persistence\n\t// Use data/context_store.json for persistence (relative to CWD: backend)\n\tpersistencePath := \"data/context_store.json\"\n\tsharedContextStore := contextstore.NewContextStore(persistencePath)\n\n\ttoolBus := server.NewToolBusService(mcpClient, sharedContextStore)\n\tmcpHandler := server.NewHandler(toolBus)\n\n\t// Inject shared store into Agent Handler too\n\tagentHandler := mcp_server.NewAgentHandler(agentUserExtractor, sharedContextStore)\n\n\t// Initialize middleware\n\trequireAuth := middleware.RequireAuth(svcMgr.Auth)\n\trequireSystemAdmin := middleware.RequireSystemAdmin()\n\n\t// MCP Endpoint (Model Context Protocol)\n\t// Supports JSON-RPC 2.0 over HTTP\n\t// 1. Require Auth (Validates Bearer token)\n\t// 2. Propagate User Context (Gin -\u003e Stdlib Context) -\u003e WrapH(mcpHandler)\n\trouter.POST(\"/mcp\", requireAuth, func(c *gin.Context) {\n\t\t// Extract user from Gin context (set by RequireAuth)\n\t\tif user, exists := c.Get(\"user\"); exists {\n\t\t\tctx := c.Request.Context()\n\t\t\t// Inject into standard context\n\t\t\tctx = context.WithValue(ctx, \"user\", user)\n\n\t\t\t// Inject Auth Token (needed for ContextStore)\n\t\t\tauthHeader := c.GetHeader(\"Authorization\")\n\t\t\tif len(authHeader) \u003e 7 \u0026\u0026 authHeader[:7] == \"Bearer \" {\n\t\t\t\ttoken := authHeader[7:]\n\t\t\t\tctx = context.WithValue(ctx, mcp.ContextKeyAuthToken, token)\n\t\t\t}\n\n\t\t\tc.Request = c.Request.WithContext(ctx)\n\t\t}\n\t\t// Forward to standard HTTP handler\n\t\tmcpHandler.ServeHTTP(c.Writer, c.Request)\n\t})\n\n\t// API routes\n\tapi := router.Group(\"/api\")\n\t{\n\t\t// Public Auth routes (no authentication required)\n\t\tauth := api.Group(\"/auth\")\n\t\t{\n\t\t\tauth.POST(\"/login\", authHandler.Login)\n\t\t\tauth.POST(\"/logout\", requireAuth, authHandler.Logout)\n\t\t\tauth.GET(\"/me\", requireAuth, authHandler.GetMe)\n\t\t\tauth.GET(\"/permissions/me\", requireAuth, authHandler.GetMyPermissions)\n\t\t\tauth.POST(\"/change-password\", requireAuth, authHandler.ChangePassword)\n\n\t\t\t// Moved to UserHandler\n\t\t\tauth.POST(\"/register\", requireAuth, requireSystemAdmin, userHandler.Register)\n\t\t\tauth.PUT(\"/users/:id\", requireAuth, requireSystemAdmin, userHandler.UpdateUser)\n\t\t\tauth.DELETE(\"/users/:id\", requireAuth, requireSystemAdmin, userHandler.DeleteUser)\n\t\t\tauth.GET(\"/users\", requireAuth, userHandler.GetUsers)\n\t\t\tauth.GET(\"/profiles\", requireAuth, userHandler.GetProfiles)\n\t\t\tauth.GET(\"/profiles/:id/permissions\", requireAuth, userHandler.GetProfilePermissions)\n\t\t\tauth.PUT(\"/profiles/:id/permissions\", requireAuth, requireSystemAdmin, userHandler.UpdateProfilePermissions)\n\t\t\tauth.GET(\"/profiles/:id/permissions/fields\", requireAuth, userHandler.GetProfileFieldPermissions)\n\t\t\tauth.PUT(\"/profiles/:id/permissions/fields\", requireAuth, requireSystemAdmin, userHandler.UpdateProfileFieldPermissions)\n\n\t\t\t// Permission Set permissions\n\t\t\tauth.POST(\"/permission-sets\", requireAuth, requireSystemAdmin, userHandler.CreatePermissionSet)\n\t\t\tauth.PUT(\"/permission-sets/:id\", requireAuth, requireSystemAdmin, userHandler.UpdatePermissionSet)\n\t\t\tauth.DELETE(\"/permission-sets/:id\", requireAuth, requireSystemAdmin, userHandler.DeletePermissionSet)\n\n\t\t\tauth.GET(\"/permission-sets/:id/permissions\", requireAuth, userHandler.GetPermissionSetPermissions)\n\t\t\tauth.PUT(\"/permission-sets/:id/permissions\", requireAuth, requireSystemAdmin, userHandler.UpdatePermissionSetPermissions)\n\t\t\tauth.GET(\"/permission-sets/:id/permissions/fields\", requireAuth, userHandler.GetPermissionSetFieldPermissions)\n\t\t\tauth.PUT(\"/permission-sets/:id/permissions/fields\", requireAuth, requireSystemAdmin, userHandler.UpdatePermissionSetFieldPermissions)\n\n\t\t\t// Effective Permissions (User)\n\t\t\tauth.GET(\"/users/:id/permissions/effective\", requireAuth, requireSystemAdmin, userHandler.GetUserEffectivePermissions)\n\t\t\tauth.GET(\"/users/:id/permissions/fields/effective\", requireAuth, requireSystemAdmin, userHandler.GetUserEffectiveFieldPermissions)\n\t\t}\n\n\t\t// Protected Formula routes\n\t\tformula := api.Group(\"/formula\")\n\t\tformula.Use(requireAuth)\n\t\t{\n\t\t\tformula.POST(\"/evaluate\", formulaHandler.Evaluate)\n\t\t\tformula.POST(\"/condition\", formulaHandler.EvaluateCondition)\n\t\t\tformula.POST(\"/substitute\", formulaHandler.Substitute)\n\t\t\tformula.POST(\"/validate\", formulaHandler.Validate)\n\t\t\tformula.GET(\"/functions\", formulaHandler.GetFunctions)\n\t\t\tformula.DELETE(\"/cache\", formulaHandler.ClearCache)\n\t\t}\n\n\t\t// Admin routes (system admin only)\n\t\tadmin := api.Group(\"/admin\")\n\t\tadmin.Use(requireAuth, requireSystemAdmin)\n\t\t{\n\t\t\tadmin.GET(\"/tables\", adminHandler.GetTableRegistry)\n\t\t\tadmin.POST(\"/validate-schema\", adminHandler.ValidateSchema)\n\t\t}\n\n\t\t// Protected Metadata routes\n\t\tmetadata := api.Group(\"/metadata\")\n\t\tmetadata.Use(requireAuth)\n\t\t{\n\t\t\tmetadata.GET(\"/apps\", uiHandler.GetApps)\n\t\t\tmetadata.POST(\"/apps\", requireSystemAdmin, uiHandler.CreateApp)\n\t\t\tmetadata.PATCH(\"/apps/:id\", requireSystemAdmin, uiHandler.UpdateApp)\n\t\t\tmetadata.DELETE(\"/apps/:id\", requireSystemAdmin, uiHandler.DeleteApp)\n\n\t\t\tmetadata.GET(\"/themes/active\", uiHandler.GetActiveTheme) // New standard endpoint\n\n\t\t\tmetadata.POST(\"/themes\", requireSystemAdmin, uiHandler.CreateTheme)\n\t\t\tmetadata.PUT(\"/themes/:id/activate\", requireSystemAdmin, uiHandler.ActivateTheme)\n\n\t\t\tmetadata.GET(\"/schemas\", metadataHandler.GetSchemas)\n\t\t\tmetadata.POST(\"/schemas\", requireSystemAdmin, metadataHandler.CreateSchema)\n\t\t\tmetadata.GET(\"/schemas/:apiName\", metadataHandler.GetSchema)\n\t\t\tmetadata.PATCH(\"/schemas/:apiName\", requireSystemAdmin, metadataHandler.UpdateSchema)\n\t\t\tmetadata.DELETE(\"/schemas/:apiName\", requireSystemAdmin, metadataHandler.DeleteSchema)\n\t\t\tmetadata.POST(\"/schemas/:apiName/fields\", requireSystemAdmin, metadataHandler.CreateField)\n\t\t\tmetadata.PATCH(\"/schemas/:apiName/fields/:fieldApiName\", requireSystemAdmin, metadataHandler.UpdateField)\n\t\t\tmetadata.DELETE(\"/schemas/:apiName/fields/:fieldApiName\", requireSystemAdmin, metadataHandler.DeleteField)\n\t\t\tmetadata.GET(\"/layouts/:objectName\", uiHandler.GetLayout)\n\t\t\tmetadata.POST(\"/layouts\", uiHandler.SaveLayout)\n\t\t\tmetadata.DELETE(\"/layouts/:id\", uiHandler.DeleteLayout)\n\t\t\tmetadata.POST(\"/layouts/assign\", uiHandler.AssignLayoutToProfile)\n\t\t\tmetadata.GET(\"/actions/:objectName\", actionHandler.GetActions)\n\t\t\tmetadata.GET(\"/actions\", actionHandler.GetAllActions)\n\t\t\tmetadata.GET(\"/actions/id/:actionId\", actionHandler.GetAction)\n\t\t\tmetadata.POST(\"/actions\", actionHandler.CreateAction)\n\t\t\tmetadata.PATCH(\"/actions/:actionId\", actionHandler.UpdateAction)\n\t\t\tmetadata.DELETE(\"/actions/:actionId\", actionHandler.DeleteAction)\n\n\t\t\t// Dashboards\n\t\t\tmetadata.GET(\"/dashboards\", uiHandler.GetDashboards)\n\t\t\tmetadata.POST(\"/dashboards\", uiHandler.CreateDashboard)\n\t\t\tmetadata.GET(\"/dashboards/:id\", uiHandler.GetDashboard)\n\t\t\tmetadata.PATCH(\"/dashboards/:id\", uiHandler.UpdateDashboard)\n\t\t\tmetadata.DELETE(\"/dashboards/:id\", uiHandler.DeleteDashboard)\n\n\t\t\t// List Views\n\t\t\tmetadata.GET(\"/listviews\", uiHandler.GetListViews)\n\t\t\tmetadata.POST(\"/listviews\", uiHandler.CreateListView)\n\t\t\tmetadata.PATCH(\"/listviews/:id\", uiHandler.UpdateListView)\n\t\t\tmetadata.DELETE(\"/listviews/:id\", uiHandler.DeleteListView)\n\n\t\t\t// Validation Rules\n\t\t\tmetadata.GET(\"/validation-rules\", metadataHandler.GetValidationRules)\n\t\t\tmetadata.POST(\"/validation-rules\", requireSystemAdmin, metadataHandler.CreateValidationRule)\n\t\t\tmetadata.PATCH(\"/validation-rules/:id\", requireSystemAdmin, metadataHandler.UpdateValidationRule)\n\t\t\tmetadata.DELETE(\"/validation-rules/:id\", requireSystemAdmin, metadataHandler.DeleteValidationRule)\n\n\t\t\t// Field Types (includes plugins)\n\t\t\tmetadata.GET(\"/fieldtypes\", metadataHandler.GetFieldTypes)\n\n\t\t\t// Flows\n\t\t\tmetadata.GET(\"/flows\", flowHandler.GetAllFlows)\n\t\t\tmetadata.GET(\"/flows/:flowId\", flowHandler.GetFlow)\n\t\t\tmetadata.POST(\"/flows\", flowHandler.CreateFlow)\n\t\t\tmetadata.PATCH(\"/flows/:flowId\", flowHandler.UpdateFlow)\n\t\t\tmetadata.DELETE(\"/flows/:flowId\", flowHandler.DeleteFlow)\n\t\t}\n\n\t\t// Protected Action routes\n\t\tactions := api.Group(\"/actions\")\n\t\tactions.Use(requireAuth)\n\t\t{\n\t\t\tactions.POST(\"/execute/:actionId\", actionHandler.ExecuteAction)\n\t\t}\n\n\t\t// Protected Flow Execution routes (Auto-Launched Flows)\n\t\tflows := api.Group(\"/flows\")\n\t\tflows.Use(requireAuth)\n\t\t{\n\t\t\tflows.POST(\"/:flowId/execute\", flowHandler.ExecuteFlow)\n\t\t}\n\n\t\t// Protected Data routes\n\t\tdata := api.Group(\"/data\")\n\t\tdata.Use(requireAuth)\n\t\t{\n\t\t\tdata.POST(\"/query\", dataHandler.Query)\n\t\t\tdata.POST(\"/analytics\", dataHandler.RunAnalytics)\n\t\t\tdata.POST(\"/search\", dataHandler.Search)\n\t\t\tdata.GET(\"/recyclebin/items\", dataHandler.GetRecycleBinItems)\n\t\t\tdata.POST(\"/recyclebin/restore/:id\", dataHandler.RestoreFromRecycleBin)\n\t\t\tdata.DELETE(\"/recyclebin/:id\", dataHandler.PurgeFromRecycleBin)\n\t\t\t// Single object search - MUST be before /:objectApiName/:id to avoid conflict\n\t\t\tdata.GET(\"/search/:objectApiName\", dataHandler.SearchSingleObject)\n\t\t\tdata.POST(\"/:objectApiName/calculate\", dataHandler.Calculate)\n\t\t\tdata.GET(\"/:objectApiName/:id\", dataHandler.GetRecord)\n\t\t\tdata.POST(\"/:objectApiName\", dataHandler.CreateRecord)\n\t\t\tdata.PATCH(\"/:objectApiName/:id\", dataHandler.UpdateRecord)\n\t\t\tdata.DELETE(\"/:objectApiName/:id\", dataHandler.DeleteRecord)\n\t\t}\n\t\t// Protected Analytics routes (System Admin Only)\n\t\tanalytics := api.Group(\"/analytics\")\n\t\tanalytics.Use(requireAuth, requireSystemAdmin)\n\t\t{\n\t\t\tanalytics.POST(\"/query\", analyticsHandler.ExecuteAdminQuery)\n\t\t}\n\n\t\t// Protected File routes\n\t\tfiles := api.Group(\"/files\")\n\t\tfiles.Use(requireAuth)\n\t\t{\n\t\t\tfiles.POST(\"/upload\", fileHandler.Upload)\n\t\t}\n\n\t\t// Protected Approval routes\n\t\tapprovals := api.Group(\"/approvals\")\n\t\tapprovals.Use(requireAuth)\n\t\t{\n\t\t\tapprovals.POST(\"/submit\", approvalHandler.Submit)\n\t\t\tapprovals.POST(\"/:workItemId/approve\", approvalHandler.Approve)\n\t\t\tapprovals.POST(\"/:workItemId/reject\", approvalHandler.Reject)\n\t\t\tapprovals.GET(\"/pending\", approvalHandler.GetPending)\n\t\t\tapprovals.GET(\"/check/:objectApiName\", approvalHandler.CheckProcess)\n\t\t\tapprovals.GET(\"/history/:objectApiName/:recordId\", approvalHandler.GetHistory)\n\t\t\tapprovals.GET(\"/flow-progress/:instanceId\", approvalHandler.GetFlowProgress)\n\t\t}\n\n\t\t// Protected Feed routes\n\t\tfeed := api.Group(\"/feed\")\n\t\tfeed.Use(requireAuth)\n\t\t{\n\t\t\tfeed.POST(\"/comments\", feedHandler.CreateComment)\n\t\t\tfeed.GET(\"/:recordId\", feedHandler.GetComments)\n\t\t}\n\n\t\t// Protected Notification routes\n\t\tnotifications := api.Group(\"/notifications\")\n\t\tnotifications.Use(requireAuth)\n\t\t{\n\t\t\tnotifications.GET(\"/\", notificationHandler.GetNotifications)\n\t\t\tnotifications.POST(\"/:id/read\", notificationHandler.MarkAsRead)\n\t\t}\n\n\t\t// Protected Agent routes\n\t\tagent := api.Group(\"/agent\")\n\t\tagent.Use(requireAuth)\n\t\t{\n\t\t\tagent.POST(\"/chat/stream\", agentHandler.ChatStream)\n\t\t}\n\t}\n\n\t// Static Files\n\trouter.Static(\"/uploads\", \"./uploads\")\n\n\t// Start background workers\n\tsvcMgr.StartOutboxWorker()\n\tlog.Println(\"üì§ Outbox event worker started (500ms polling)\")\n\n\t// Start server\n\tlog.Println(\"\\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\")\n\tlog.Println(\"üöÄ NexusCRM Golang Backend Started Successfully\")\n\tlog.Println(\"‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\")\n\tlog.Printf(\"\\nüìç Server:         http://localhost:%s\", port)\n\tlog.Printf(\"üîê Auth API:       http://localhost:%s/api/auth\", port)\n\tlog.Printf(\"üìê Formula API:    http://localhost:%s/api/formula\", port)\n\tlog.Printf(\"üìä Metadata API:   http://localhost:%s/api/metadata\", port)\n\tlog.Printf(\"ü§ñ MCP Endpoint:   http://localhost:%s/mcp\", port)\n\tlog.Printf(\"üíæ Data API:       http://localhost:%s/api/data\", port)\n\tlog.Printf(\"üíö Health check:   http://localhost:%s/health\\n\", port)\n\n\tif err := router.Run(\"0.0.0.0:\" + port); err != nil {\n\t\tlog.Fatalf(\"Failed to start server: %v\", err)\n\t}\n}\n",
        "token_size": 4579
      }
    }
  },
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjp7ImlkIjoiMTAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAxIiwibmFtZSI6ImFkbWluQHRlc3QuY29tIiwiZW1haWwiOiJhZG1pbkB0ZXN0LmNvbSIsInByb2ZpbGVfaWQiOiJzeXN0ZW1fYWRtaW4ifSwiZXhwIjoxNzY2OTEzMzUyLCJpYXQiOjE3NjY4MjY5NTIsImp0aSI6ImQ5YWYzNjY3LTEwNjUtNDljMS04MjM2LTU5ZTEzZjNmM2ZkNiJ9.4f4QJkXQcK0kZXqBx53mDLwGH1ccbgU4cyVfNp7nxhQ": {
    "items": {
      "/Users/qiliu/projects/nexuscrm/frontend/src/components/ai/ContextPanel.tsx": {
        "path": "/Users/qiliu/projects/nexuscrm/frontend/src/components/ai/ContextPanel.tsx",
        "content": "\nimport React, { useState, useMemo } from 'react';\nimport {\n    FileCode,\n    Database,\n    X,\n    RefreshCw,\n    Minimize2,\n    AlertTriangle,\n    History,\n    Plus,\n    Trash2,\n    FolderOpen,\n    FileText,\n    FileJson,\n    FileType,\n    MessageSquare,\n    User,\n    Bot,\n    Wrench,\n    ChevronDown,\n    ChevronUp,\n    Settings,\n    Lock,\n    Cpu,\n    Eye\n} from 'lucide-react';\nimport { ChatMessage, agentApi, ContextItem } from '../../infrastructure/api/agent';\nimport { formatRelativeTime, formatFullTime } from './utils';\nimport { ContextInspector } from './ContextInspector';\n\ninterface ContextFile {\n    path: string;\n    tokenSize: number;\n}\n\ninterface ContextPanelProps {\n    files: ContextFile[];\n    messages: ChatMessage[];\n    toolsList: string[];\n    systemPromptTokens: number;\n    toolsTokens: number;\n    totalTokens: number;\n    conversationTokens: number;\n    maxTokens: number;\n    isOpen: boolean;\n    hasSummary: boolean;\n    tokensSaved: number;\n    isLoading: boolean;\n    onClose: () =\u003e void;\n    onRemoveFile: (path: string) =\u003e void;\n    onRemoveMessage: (index: number) =\u003e void;\n    onCompact: () =\u003e void;\n    onRefresh: () =\u003e void;\n    onAddFiles?: () =\u003e void;\n    width: number;\n}\n\n// Get file icon based on extension\nfunction getFileIcon(path: string) {\n    const ext = path.split('.').pop()?.toLowerCase() || '';\n    switch (ext) {\n        case 'tsx':\n        case 'jsx':\n            return \u003cFileCode size={14} className=\"text-blue-500\" /\u003e;\n        case 'ts':\n        case 'js':\n            return \u003cFileCode size={14} className=\"text-yellow-500\" /\u003e;\n        case 'json':\n            return \u003cFileJson size={14} className=\"text-amber-500\" /\u003e;\n        case 'md':\n        case 'txt':\n            return \u003cFileText size={14} className=\"text-slate-500\" /\u003e;\n        case 'go':\n            return \u003cFileCode size={14} className=\"text-cyan-500\" /\u003e;\n        default:\n            return \u003cFileType size={14} className=\"text-slate-400\" /\u003e;\n    }\n}\n\n// Estimate tokens for a message\nfunction estimateTokens(msg: ChatMessage): number {\n    let tokens = Math.ceil((msg.content || '').length / 4);\n    if (msg.tool_calls) {\n        tokens += msg.tool_calls.reduce((acc, tc) =\u003e acc + Math.ceil((tc.function.arguments || '').length / 4), 0);\n    }\n    return tokens;\n}\n\n// Get role icon and color\n// Get role icon and color - Dark Mode Adjusted\nfunction getRoleStyle(role: string) {\n    switch (role) {\n        case 'user':\n            return { icon: User, bg: 'bg-indigo-500/10', text: 'text-indigo-300', label: 'You' };\n        case 'assistant':\n            return { icon: Bot, bg: 'bg-emerald-500/10', text: 'text-emerald-300', label: 'AI' };\n        case 'tool':\n            return { icon: Wrench, bg: 'bg-amber-500/10', text: 'text-amber-300', label: 'Tool' };\n        case 'system':\n            return { icon: Database, bg: 'bg-slate-800/50', text: 'text-slate-400', label: 'System' };\n        default:\n            return { icon: MessageSquare, bg: 'bg-slate-800/50', text: 'text-slate-400', label: role };\n    }\n}\n\n// System prompt preview\nconst SYSTEM_PROMPT_PREVIEW = `You are Nexus, an AI assistant for NexusCRM.\n\nPRINCIPLES:\n1. EXPLORE BEFORE ACTING - Like exploring a new codebase, first understand what's available, then dive into specifics.\n2. TREE EXPLORATION - Start broad (list all), then narrow down (get details), then act (CRUD). Don't try to do everything at once.\n\nYou have access to a dynamic CRM system. Objects and fields are metadata-driven. Think step by step. If a tool fails, read the error and adapt.`;\n\n// Common file suggestions\nconst SUGGESTED_FILES = [\n    { name: 'AIAssistant.tsx', path: '/add AIAssistant.tsx' },\n    { name: 'package.json', path: '/add package.json' },\n    { name: 'types.ts', path: '/add types.ts' },\n];\n\ntype TabType = 'system' | 'conversation' | 'files';\n\nexport function ContextPanel({\n    files,\n    messages,\n    toolsList,\n    systemPromptTokens,\n    toolsTokens,\n    totalTokens,\n    conversationTokens,\n    maxTokens,\n    isOpen,\n    hasSummary,\n    tokensSaved,\n    isLoading,\n    onClose,\n    onRemoveFile,\n    onRemoveMessage,\n    onCompact,\n    onRefresh,\n    onAddFiles,\n    width\n}: ContextPanelProps) {\n    const [activeTab, setActiveTab] = useState\u003cTabType\u003e('conversation');\n    const [expandedMessages, setExpandedMessages] = useState\u003cSet\u003cnumber\u003e\u003e(new Set());\n    const [toolsExpanded, setToolsExpanded] = useState(false);\n    const [summaryExpanded, setSummaryExpanded] = useState(false);\n    const [isInspectorOpen, setIsInspectorOpen] = useState(false);\n    const [realSystemPrompt, setRealSystemPrompt] = useState\u003cstring | null\u003e(null);\n    const [fullFiles, setFullFiles] = useState\u003cContextItem[] | null\u003e(null);\n\n    // Fetch full context (including content) when inspector opens\n    React.useEffect(() =\u003e {\n        if (isInspectorOpen) {\n            agentApi.getContext(true)\n                .then(data =\u003e {\n                    setRealSystemPrompt(data.system_prompt || null);\n                    setFullFiles(data.items);\n                })\n                .catch(err =\u003e console.error(\"Failed to fetch full context inspection:\", err));\n        }\n    }, [isInspectorOpen]);\n\n    // Calculate max file size for heatmap\n    const maxFileTokenSize = useMemo(() =\u003e {\n        return Math.max(...files.map(f =\u003e f.tokenSize), 1);\n    }, [files]);\n\n    if (!isOpen) return null;\n\n    // Extract summary from system message if present\n    const systemMessage = messages.find(m =\u003e m.role === 'system');\n    let summaryContent: string | null = null;\n    let summaryTokensSaved: number | null = null;\n    let compactedAt: string | null = null;\n\n    if (systemMessage?.content) {\n        // Match: --- CONVERSATION SUMMARY (Saved ~123 tokens | Compacted: Dec 28, 11:30 AM) ---\n        const summaryMatch = systemMessage.content.match(/--- CONVERSATION SUMMARY \\(Saved ~(\\d+) tokens(?: \\| Compacted: ([^)]+))?\\) ---\\n([\\s\\S]*?)\\n--- END SUMMARY ---/);\n        if (summaryMatch) {\n            summaryTokensSaved = parseInt(summaryMatch[1], 10);\n            compactedAt = summaryMatch[2] || null;\n            summaryContent = summaryMatch[3].trim();\n        }\n    }\n\n    // Calculate total including system overhead\n    const systemOverhead = systemPromptTokens + toolsTokens;\n    const allTokens = systemOverhead + totalTokens + conversationTokens;\n    const usagePercent = Math.min((allTokens / maxTokens) * 100, 100);\n\n    // Individual percentages for segmented bar\n    const systemPercent = (systemPromptTokens / maxTokens) * 100;\n    const toolsPercent = (toolsTokens / maxTokens) * 100;\n    const filesPercent = (totalTokens / maxTokens) * 100;\n    const chatPercent = (conversationTokens / maxTokens) * 100;\n\n    const showWarning = usagePercent \u003e= 70;\n    const showCompactButton = conversationTokens \u003e 500 \u0026\u0026 !summaryContent;\n\n    // Filter out system messages for display\n    const displayMessages = messages.filter(m =\u003e m.role !== 'system');\n\n    const toggleMessageExpand = (index: number) =\u003e {\n        const newExpanded = new Set(expandedMessages);\n        if (newExpanded.has(index)) {\n            newExpanded.delete(index);\n        } else {\n            newExpanded.add(index);\n        }\n        setExpandedMessages(newExpanded);\n    };\n\n    return (\n        \u003cdiv\n            className=\"border-r border-slate-200 bg-white flex flex-col h-full animate-slide-right transition-[width] duration-0\"\n            style={{ width: `${width}px`, minWidth: '320px' }}\n        \u003e\n            {/* Header */}\n            \u003cdiv className=\"px-4 py-3 border-b border-slate-200 flex justify-between items-center\"\u003e\n                \u003cdiv\u003e\n                    \u003ch3 className=\"font-semibold text-sm text-slate-800 flex items-center gap-2\"\u003e\n                        \u003cDatabase size={16} className=\"text-indigo-500\" /\u003e\n                        Active Context\n                    \u003c/h3\u003e\n                    \u003cp className=\"text-[10px] text-slate-400 mt-0.5\"\u003eEverything the AI receives\u003c/p\u003e\n                \u003c/div\u003e\n                \u003cdiv className=\"flex items-center gap-0.5\"\u003e\n                    {onAddFiles \u0026\u0026 (\n                        \u003cbutton\n                            onClick={onAddFiles}\n                            className=\"p-1.5 hover:bg-indigo-50 rounded-lg text-indigo-500 hover:text-indigo-600 transition-colors\"\n                            title=\"Add files to context\"\n                        \u003e\n                            \u003cPlus size={16} /\u003e\n                        \u003c/button\u003e\n                    )}\n                    \u003cbutton\n                        onClick={() =\u003e setIsInspectorOpen(true)}\n                        className=\"p-1.5 hover:bg-indigo-50 rounded-lg text-slate-400 hover:text-indigo-600 transition-colors\"\n                        title=\"Inspect full context prompt\"\n                    \u003e\n                        \u003cEye size={14} /\u003e\n                    \u003c/button\u003e\n                    \u003cbutton\n                        onClick={onRefresh}\n                        disabled={isLoading}\n                        className=\"p-1.5 hover:bg-slate-100 rounded-lg text-slate-400 hover:text-slate-600 transition-colors disabled:opacity-50\"\n                        title=\"Refresh context\"\n                    \u003e\n                        \u003cRefreshCw size={14} className={isLoading ? 'animate-spin' : ''} /\u003e\n                    \u003c/button\u003e\n                    \u003cbutton\n                        onClick={onClose}\n                        className=\"p-1.5 hover:bg-slate-100 rounded-lg text-slate-400 hover:text-slate-600 transition-colors\"\n                        title=\"Close panel\"\n                    \u003e\n                        \u003cX size={14} /\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n\n            {/* Token Usage - Complete Breakdown */}\n            \u003cdiv className=\"p-3 border-b border-white/5 bg-black/20\"\u003e\n                \u003cdiv className=\"flex justify-between items-baseline mb-1.5\"\u003e\n                    \u003cspan className=\"text-[11px] font-medium text-slate-400\"\u003eToken Usage\u003c/span\u003e\n                    \u003cspan className={`text-[11px] font-mono ${usagePercent \u003e 70 ? 'text-amber-400' : 'text-slate-500'}`}\u003e\n                        {allTokens.toLocaleString()} / {(maxTokens / 1000).toFixed(0)}K\n                    \u003c/span\u003e\n                \u003c/div\u003e\n\n                {/* Segmented Progress Bar - 4 segments */}\n                \u003cdiv className=\"w-full h-2 bg-slate-800 rounded-full overflow-hidden flex\"\u003e\n                    \u003cdiv\n                        className=\"h-full bg-slate-500 transition-all duration-500\"\n                        style={{ width: `${systemPercent}%` }}\n                        title={`System Prompt: ~${systemPromptTokens.toLocaleString()} tokens`}\n                    /\u003e\n                    \u003cdiv\n                        className=\"h-full bg-purple-400 transition-all duration-500\"\n                        style={{ width: `${toolsPercent}%` }}\n                        title={`Tools: ~${toolsTokens.toLocaleString()} tokens`}\n                    /\u003e\n                    \u003cdiv\n                        className=\"h-full bg-emerald-500 transition-all duration-500\"\n                        style={{ width: `${filesPercent}%` }}\n                        title={`Files: ~${totalTokens.toLocaleString()} tokens`}\n                    /\u003e\n                    \u003cdiv\n                        className=\"h-full bg-indigo-400 transition-all duration-500\"\n                        style={{ width: `${chatPercent}%` }}\n                        title={`Chat: ~${conversationTokens.toLocaleString()} tokens`}\n                    /\u003e\n                \u003c/div\u003e\n\n                {/* Legend - 2 rows */}\n                \u003cdiv className=\"mt-2 grid grid-cols-2 gap-x-2 gap-y-1 text-[10px]\"\u003e\n                    \u003cdiv className=\"flex items-center gap-1\"\u003e\n                        \u003cdiv className=\"w-2 h-2 rounded-full bg-slate-400\" /\u003e\n                        \u003cspan className=\"text-slate-500\"\u003eSystem {systemPromptTokens}\u003c/span\u003e\n                    \u003c/div\u003e\n                    \u003cdiv className=\"flex items-center gap-1\"\u003e\n                        \u003cdiv className=\"w-2 h-2 rounded-full bg-purple-400\" /\u003e\n                        \u003cspan className=\"text-slate-500\"\u003eTools {toolsTokens}\u003c/span\u003e\n                    \u003c/div\u003e\n                    \u003cdiv className=\"flex items-center gap-1\"\u003e\n                        \u003cdiv className=\"w-2 h-2 rounded-full bg-emerald-500\" /\u003e\n                        \u003cspan className=\"text-slate-500\"\u003eFiles {totalTokens}\u003c/span\u003e\n                    \u003c/div\u003e\n                    \u003cdiv className=\"flex items-center gap-1\"\u003e\n                        \u003cdiv className=\"w-2 h-2 rounded-full bg-indigo-400\" /\u003e\n                        \u003cspan className=\"text-slate-500\"\u003eChat {conversationTokens}\u003c/span\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n\n                {/* Warning \u0026 Compact */}\n                {showWarning \u0026\u0026 (\n                    \u003cdiv className=\"mt-2 p-2 bg-amber-900/20 border border-amber-900/40 rounded-lg flex items-start gap-2\"\u003e\n                        \u003cAlertTriangle size={12} className=\"text-amber-500 mt-0.5 flex-shrink-0\" /\u003e\n                        \u003cdiv className=\"text-[10px] text-amber-500\"\u003eContext getting full\u003c/div\u003e\n                    \u003c/div\u003e\n                )}\n                {showCompactButton \u0026\u0026 !hasSummary \u0026\u0026 (\n                    \u003cbutton\n                        onClick={onCompact}\n                        disabled={isLoading}\n                        className=\"mt-2 w-full flex items-center justify-center gap-1.5 px-2 py-1.5 bg-indigo-500/10 hover:bg-indigo-500/20 border border-indigo-500/20 text-indigo-300 text-[11px] font-medium rounded-lg transition-colors disabled:opacity-50\"\n                    \u003e\n                        \u003cMinimize2 size={12} /\u003e\n                        Compact Conversation\n                    \u003c/button\u003e\n                )}\n            \u003c/div\u003e\n\n            {/* Summary Indicator */}\n            {\n                hasSummary \u0026\u0026 (\n                    \u003cdiv className=\"px-3 py-2 bg-emerald-50 border-b border-emerald-100 flex items-center gap-2\"\u003e\n                        \u003cHistory size={14} className=\"text-emerald-600 flex-shrink-0\" /\u003e\n                        \u003cdiv className=\"flex-1 min-w-0\"\u003e\n                            \u003cdiv className=\"text-[11px] font-medium text-emerald-800\"\u003eSummarized\u003c/div\u003e\n                            {tokensSaved \u003e 0 \u0026\u0026 (\n                                \u003cdiv className=\"text-[10px] text-emerald-600\"\u003eSaved ~{tokensSaved.toLocaleString()}\u003c/div\u003e\n                            )}\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n                )\n            }\n\n            {/* Tabs - 3 tabs */}\n            \u003cdiv className=\"flex border-b border-white/5\"\u003e\n                \u003cbutton\n                    onClick={() =\u003e setActiveTab('system')}\n                    className={`flex-1 px-2 py-2 text-[11px] font-medium transition-colors ${activeTab === 'system'\n                        ? 'text-indigo-400 border-b-2 border-indigo-500 bg-indigo-500/10'\n                        : 'text-slate-500 hover:text-slate-300 hover:bg-white/5'\n                        }`}\n                \u003e\n                    \u003cSettings size={11} className=\"inline mr-1\" /\u003e\n                    System\n                \u003c/button\u003e\n                \u003cbutton\n                    onClick={() =\u003e setActiveTab('conversation')}\n                    className={`flex-1 px-2 py-2 text-[11px] font-medium transition-colors ${activeTab === 'conversation'\n                        ? 'text-indigo-400 border-b-2 border-indigo-500 bg-indigo-500/10'\n                        : 'text-slate-500 hover:text-slate-300 hover:bg-white/5'\n                        }`}\n                \u003e\n                    \u003cMessageSquare size={11} className=\"inline mr-1\" /\u003e\n                    Chat ({displayMessages.length})\n                \u003c/button\u003e\n                \u003cbutton\n                    onClick={() =\u003e setActiveTab('files')}\n                    className={`flex-1 px-2 py-2 text-[11px] font-medium transition-colors ${activeTab === 'files'\n                        ? 'text-indigo-400 border-b-2 border-indigo-500 bg-indigo-500/10'\n                        : 'text-slate-500 hover:text-slate-300 hover:bg-white/5'\n                        }`}\n                \u003e\n                    \u003cFolderOpen size={11} className=\"inline mr-1\" /\u003e\n                    Files ({files.length})\n                \u003c/button\u003e\n            \u003c/div\u003e\n\n            {/* Content Area */}\n            \u003cdiv className=\"flex-1 overflow-y-auto\"\u003e\n                {activeTab === 'system' ? (\n                    /* System Tab */\n                    \u003cdiv className=\"p-3 space-y-3\"\u003e\n                        {/* System Prompt Section */}\n                        \u003cdiv className=\"bg-slate-50 rounded-lg p-3\"\u003e\n                            \u003cdiv className=\"flex items-center justify-between mb-2\"\u003e\n                                \u003cdiv className=\"flex items-center gap-1.5\"\u003e\n                                    \u003cLock size={12} className=\"text-slate-400\" /\u003e\n                                    \u003cspan className=\"text-[11px] font-medium text-slate-600\"\u003eSystem Prompt\u003c/span\u003e\n                                \u003c/div\u003e\n                                \u003cspan className=\"text-[10px] text-slate-400\"\u003e~{systemPromptTokens} tokens\u003c/span\u003e\n                            \u003c/div\u003e\n                            \u003cdiv className=\"text-[10px] text-slate-500 leading-relaxed whitespace-pre-wrap max-h-32 overflow-y-auto bg-white rounded p-2 border border-slate-100\"\u003e\n                                {SYSTEM_PROMPT_PREVIEW}\n                            \u003c/div\u003e\n                            \u003cdiv className=\"mt-1.5 text-[9px] text-slate-400 flex items-center gap-1\"\u003e\n                                \u003cLock size={9} /\u003e\n                                Read-only (fixed overhead)\n                            \u003c/div\u003e\n                        \u003c/div\u003e\n\n                        {/* Tools Section */}\n                        \u003cdiv className=\"bg-purple-50 rounded-lg p-3\"\u003e\n                            \u003cbutton\n                                onClick={() =\u003e setToolsExpanded(!toolsExpanded)}\n                                className=\"w-full flex items-center justify-between\"\n                            \u003e\n                                \u003cdiv className=\"flex items-center gap-1.5\"\u003e\n                                    \u003cCpu size={12} className=\"text-purple-500\" /\u003e\n                                    \u003cspan className=\"text-[11px] font-medium text-purple-700\"\u003e\n                                        Tools ({toolsList.length})\n                                    \u003c/span\u003e\n                                \u003c/div\u003e\n                                \u003cdiv className=\"flex items-center gap-2\"\u003e\n                                    \u003cspan className=\"text-[10px] text-purple-400\"\u003e~{toolsTokens} tok\u003c/span\u003e\n                                    {toolsExpanded ? (\n                                        \u003cChevronUp size={12} className=\"text-purple-400\" /\u003e\n                                    ) : (\n                                        \u003cChevronDown size={12} className=\"text-purple-400\" /\u003e\n                                    )}\n                                \u003c/div\u003e\n                            \u003c/button\u003e\n\n                            {toolsExpanded \u0026\u0026 (\n                                \u003cdiv className=\"mt-2 space-y-1 max-h-48 overflow-y-auto\"\u003e\n                                    {toolsList.map((tool, idx) =\u003e (\n                                        \u003cdiv\n                                            key={idx}\n                                            className=\"flex items-center gap-2 px-2 py-1.5 bg-white rounded text-[10px] text-slate-600\"\n                                        \u003e\n                                            \u003cWrench size={10} className=\"text-purple-400\" /\u003e\n                                            {tool}\n                                        \u003c/div\u003e\n                                    ))}\n                                \u003c/div\u003e\n                            )}\n\n                            \u003cdiv className=\"mt-1.5 text-[9px] text-purple-400 flex items-center gap-1\"\u003e\n                                \u003cLock size={9} /\u003e\n                                Available tools (fixed overhead)\n                            \u003c/div\u003e\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n                ) : activeTab === 'conversation' ? (\n                    /* Conversation Tab */\n                    displayMessages.length === 0 \u0026\u0026 !summaryContent ? (\n                        \u003cdiv className=\"flex flex-col items-center justify-center h-full px-6 py-8 text-center\"\u003e\n                            \u003cMessageSquare size={32} className=\"text-slate-300 mb-2\" /\u003e\n                            \u003cp className=\"text-xs text-slate-400\"\u003eNo conversation yet\u003c/p\u003e\n                        \u003c/div\u003e\n                    ) : (\n                        \u003cdiv className=\"p-2 space-y-1\"\u003e\n                            {/* Summary Card - shown when context has been compacted */}\n                            {summaryContent \u0026\u0026 (\n                                \u003cdiv className=\"bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg p-3 border border-emerald-200 mb-2\"\u003e\n                                    \u003cdiv className=\"flex items-center justify-between mb-2\"\u003e\n                                        \u003cdiv className=\"flex items-center gap-2\"\u003e\n                                            \u003cdiv className=\"w-6 h-6 rounded-md bg-emerald-100 flex items-center justify-center\"\u003e\n                                                \u003cHistory size={12} className=\"text-emerald-600\" /\u003e\n                                            \u003c/div\u003e\n                                            \u003cdiv\u003e\n                                                \u003cdiv className=\"flex items-center gap-1.5\"\u003e\n                                                    \u003cspan className=\"text-[11px] font-semibold text-emerald-700\"\u003ePrevious Context\u003c/span\u003e\n                                                    {compactedAt \u0026\u0026 (\n                                                        \u003cspan className=\"text-[9px] text-emerald-500\"\u003e‚Ä¢ {compactedAt}\u003c/span\u003e\n                                                    )}\n                                                \u003c/div\u003e\n                                                {summaryTokensSaved \u0026\u0026 (\n                                                    \u003cspan className=\"text-[9px] text-emerald-500\"\u003e\n                                                        saved ~{summaryTokensSaved.toLocaleString()} tokens\n                                                    \u003c/span\u003e\n                                                )}\n                                            \u003c/div\u003e\n                                        \u003c/div\u003e\n                                        \u003cbutton\n                                            onClick={() =\u003e setSummaryExpanded(!summaryExpanded)}\n                                            className=\"p-1 hover:bg-emerald-100 rounded transition-colors\"\n                                        \u003e\n                                            {summaryExpanded ? (\n                                                \u003cChevronUp size={14} className=\"text-emerald-500\" /\u003e\n                                            ) : (\n                                                \u003cChevronDown size={14} className=\"text-emerald-500\" /\u003e\n                                            )}\n                                        \u003c/button\u003e\n                                    \u003c/div\u003e\n\n                                    \u003cdiv className={`text-[10px] text-emerald-700 leading-relaxed ${summaryExpanded ? '' : 'line-clamp-2'}`}\u003e\n                                        {summaryContent}\n                                    \u003c/div\u003e\n\n                                    {!summaryExpanded \u0026\u0026 summaryContent.length \u003e 120 \u0026\u0026 (\n                                        \u003cbutton\n                                            onClick={() =\u003e setSummaryExpanded(true)}\n                                            className=\"text-[10px] text-emerald-600 hover:text-emerald-700 mt-1 font-medium\"\n                                        \u003e\n                                            Show full summary\n                                        \u003c/button\u003e\n                                    )}\n                                \u003c/div\u003e\n                            )}\n\n                            {displayMessages.length === 0 ? (\n                                \u003cdiv className=\"text-center py-4\"\u003e\n                                    \u003cp className=\"text-[11px] text-slate-400\"\u003eRecent messages cleared by compaction\u003c/p\u003e\n                                \u003c/div\u003e\n                            ) : (\n                                displayMessages.map((msg, idx) =\u003e {\n                                    const style = getRoleStyle(msg.role);\n                                    const IconComponent = style.icon;\n                                    const tokens = estimateTokens(msg);\n                                    const isExpanded = expandedMessages.has(idx);\n\n                                    // Format content for display, handling tool calls and results\n                                    let displayContent = msg.content || '';\n                                    if (msg.role === 'assistant' \u0026\u0026 msg.tool_calls \u0026\u0026 msg.tool_calls.length \u003e 0) {\n                                        const toolNames = msg.tool_calls.map(tc =\u003e tc.function.name).join(', ');\n                                        const label = `[Calling: ${toolNames}]`;\n                                        displayContent = displayContent ? `${displayContent}\\n${label}` : label;\n                                    } else if (msg.role === 'tool') {\n                                        displayContent = `[Result (${msg.name || 'Tool'}): ${displayContent}]`;\n                                    }\n\n                                    const preview = displayContent.slice(0, 60);\n                                    const hasMore = displayContent.length \u003e 60;\n                                    const relTime = formatRelativeTime(msg.timestamp);\n                                    const fullTime = formatFullTime(msg.timestamp);\n\n                                    const originalIndex = messages.indexOf(msg);\n\n                                    return (\n                                        \u003cdiv\n                                            key={idx}\n                                            className=\"group bg-slate-50 hover:bg-slate-100 rounded-lg p-2 transition-colors\"\n                                        \u003e\n                                            \u003cdiv className=\"flex items-start gap-2\"\u003e\n                                                \u003cdiv className={`w-6 h-6 rounded-md ${style.bg} flex items-center justify-center flex-shrink-0`}\u003e\n                                                    \u003cIconComponent size={12} className={style.text} /\u003e\n                                                \u003c/div\u003e\n                                                \u003cdiv className=\"flex-1 min-w-0\"\u003e\n                                                    \u003cdiv className=\"flex items-center justify-between mb-0.5\"\u003e\n                                                        \u003cspan className={`text-[10px] font-medium ${style.text}`}\u003e{style.label}\u003c/span\u003e\n                                                        \u003cspan className=\"text-[9px] text-slate-400\" title={fullTime}\u003e\n                                                            {relTime ? `${relTime} ‚Ä¢ ` : ''}~{tokens} tok\n                                                        \u003c/span\u003e\n                                                    \u003c/div\u003e\n                                                    \u003cdiv className=\"text-[11px] text-slate-600 leading-relaxed\"\u003e\n                                                        {isExpanded ? displayContent : preview}\n                                                        {!isExpanded \u0026\u0026 hasMore \u0026\u0026 '...'}\n                                                    \u003c/div\u003e\n                                                    {hasMore \u0026\u0026 (\n                                                        \u003cbutton\n                                                            onClick={() =\u003e toggleMessageExpand(idx)}\n                                                            className=\"text-[10px] text-indigo-500 hover:text-indigo-600 mt-1 flex items-center gap-0.5\"\n                                                        \u003e\n                                                            {isExpanded ? (\n                                                                \u003c\u003eShow less \u003cChevronUp size={10} /\u003e\u003c/\u003e\n                                                            ) : (\n                                                                \u003c\u003eShow more \u003cChevronDown size={10} /\u003e\u003c/\u003e\n                                                            )}\n                                                        \u003c/button\u003e\n                                                    )}\n                                                \u003c/div\u003e\n                                                \u003cbutton\n                                                    onClick={() =\u003e onRemoveMessage(originalIndex)}\n                                                    className=\"p-1 rounded text-slate-300 hover:text-red-500 hover:bg-red-50 transition-all opacity-0 group-hover:opacity-100\"\n                                                    title=\"Remove from context\"\n                                                \u003e\n                                                    \u003cTrash2 size={12} /\u003e\n                                                \u003c/button\u003e\n                                            \u003c/div\u003e\n                                        \u003c/div\u003e\n                                    );\n                                })\n                            )}\n                            {displayMessages.length \u003e 0 \u0026\u0026 (\n                                \u003cbutton\n                                    onClick={() =\u003e {\n                                        for (let i = messages.length - 1; i \u003e= 0; i--) {\n                                            if (messages[i].role !== 'system') {\n                                                onRemoveMessage(i);\n                                            }\n                                        }\n                                    }}\n                                    className=\"w-full mt-2 text-[10px] text-slate-400 hover:text-red-500 transition-colors py-1\"\n                                \u003e\n                                    Clear all conversation\n                                \u003c/button\u003e\n                            )}\n                        \u003c/div\u003e\n                    )\n                ) : (\n                    /* Files Tab */\n                    files.length === 0 ? (\n                        \u003cdiv className=\"flex flex-col items-center justify-center h-full px-6 py-8 text-center\"\u003e\n                            \u003cdiv className=\"w-12 h-12 rounded-xl bg-slate-100 flex items-center justify-center mb-3\"\u003e\n                                \u003cFolderOpen size={24} className=\"text-slate-400\" /\u003e\n                            \u003c/div\u003e\n                            \u003ch4 className=\"text-sm font-medium text-slate-700 mb-1\"\u003eNo files pinned\u003c/h4\u003e\n                            \u003cp className=\"text-xs text-slate-400 mb-4 max-w-[200px]\"\u003e\n                                Add files to give the AI context\n                            \u003c/p\u003e\n\n                            {onAddFiles \u0026\u0026 (\n                                \u003cbutton\n                                    onClick={onAddFiles}\n                                    className=\"flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg shadow-sm hover:shadow transition-all\"\n                                \u003e\n                                    \u003cPlus size={16} /\u003e\n                                    Add Files\n                                \u003c/button\u003e\n                            )}\n\n                            \u003cdiv className=\"mt-4 w-full\"\u003e\n                                \u003cdiv className=\"text-[10px] text-slate-400 uppercase tracking-wider mb-2\"\u003eQuick add\u003c/div\u003e\n                                \u003cdiv className=\"flex flex-wrap justify-center gap-1.5\"\u003e\n                                    {SUGGESTED_FILES.map((file) =\u003e (\n                                        \u003cbutton\n                                            key={file.name}\n                                            onClick={() =\u003e onAddFiles?.()}\n                                            className=\"px-2 py-1 bg-slate-100 hover:bg-slate-200 text-slate-600 text-[11px] rounded-md transition-colors\"\n                                        \u003e\n                                            {file.name}\n                                        \u003c/button\u003e\n                                    ))}\n                                \u003c/div\u003e\n                            \u003c/div\u003e\n                        \u003c/div\u003e\n                    ) : (\n                        \u003cdiv className=\"p-2 space-y-1.5\"\u003e\n                            \u003cdiv className=\"flex items-center justify-between px-2 py-1\"\u003e\n                                \u003cspan className=\"text-[10px] text-slate-400 uppercase tracking-wider font-medium\"\u003e\n                                    Files ({files.length})\n                                \u003c/span\u003e\n                                {files.length \u003e 0 \u0026\u0026 (\n                                    \u003cbutton\n                                        onClick={() =\u003e files.forEach(f =\u003e onRemoveFile(f.path))}\n                                        className=\"text-[10px] text-slate-400 hover:text-red-500 transition-colors\"\n                                        title=\"Remove all files\"\n                                    \u003e\n                                        Clear all\n                                    \u003c/button\u003e\n                                )}\n                            \u003c/div\u003e\n\n                            {files.map((file, idx) =\u003e (\n                                \u003cdiv\n                                    key={idx}\n                                    className=\"relative flex items-center gap-2 px-3 py-2.5 bg-slate-50 hover:bg-slate-100 rounded-lg transition-colors group overflow-hidden\"\n                                \u003e\n                                    {/* Heatmap Bar */}\n                                    \u003cdiv\n                                        className=\"absolute left-0 top-0 bottom-0 bg-emerald-100/40 pointer-events-none transition-all duration-500\"\n                                        style={{ width: `${(file.tokenSize / maxFileTokenSize) * 100}%` }}\n                                    /\u003e\n\n                                    \u003cdiv className=\"relative z-10 flex items-center gap-2 flex-1 min-w-0\"\u003e\n                                        {getFileIcon(file.path)}\n                                        \u003cdiv className=\"flex-1 min-w-0\"\u003e\n                                            \u003cdiv className=\"text-xs font-medium text-slate-700 truncate\" title={file.path}\u003e\n                                                {file.path.split('/').pop()}\n                                            \u003c/div\u003e\n                                            \u003cdiv className=\"text-[10px] text-slate-400\"\u003e\n                                                ~{file.tokenSize.toLocaleString()} tokens\n                                            \u003c/div\u003e\n                                        \u003c/div\u003e\n                                    \u003c/div\u003e\n\n                                    \u003cbutton\n                                        onClick={() =\u003e onRemoveFile(file.path)}\n                                        className=\"relative z-10 p-1 rounded text-slate-300 hover:text-red-500 hover:bg-red-50 transition-all opacity-60 group-hover:opacity-100\"\n                                        title=\"Remove from context\"\n                                    \u003e\n                                        \u003cTrash2 size={14} /\u003e\n                                    \u003c/button\u003e\n                                \u003c/div\u003e\n                            ))}\n                        \u003c/div\u003e\n                    )\n                )}\n            \u003c/div\u003e\n            \u003cContextInspector\n                isOpen={isInspectorOpen}\n                onClose={() =\u003e setIsInspectorOpen(false)}\n                systemPrompt={realSystemPrompt || SYSTEM_PROMPT_PREVIEW}\n                files={(fullFiles as any) || files}\n                messages={messages}\n            /\u003e\n        \u003c/div\u003e\n    );\n}\n",
        "token_size": 9065
      },
      "/Users/qiliu/projects/nexuscrm/frontend/src/infrastructure/api/agent.ts": {
        "path": "/Users/qiliu/projects/nexuscrm/frontend/src/infrastructure/api/agent.ts",
        "content": "import { apiClient } from './client';\nimport { API_CONFIG } from '../../core/constants/EnvironmentConfig';\n\nexport interface ToolCall {\n    id: string;\n    type: 'function';\n    function: {\n        name: string;\n        arguments: string;\n    };\n}\n\nexport interface ChatMessage {\n    role: string;\n    content: string;\n    name?: string;\n    tool_calls?: ToolCall[];\n    tool_call_id?: string;\n    timestamp?: string; // ISO timestamp string from backend\n}\n\nexport interface ChatRequest {\n    messages: ChatMessage[];\n    model?: string;\n}\n\nexport interface ChatResponse {\n    content: string;\n    history: ChatMessage[];\n}\n\n// Streaming types\nexport type StreamEventType = 'thinking' | 'tool_call' | 'tool_result' | 'content' | 'done' | 'error' | 'auto_compact';\n\nexport interface StreamEvent {\n    type: StreamEventType;\n    content?: string;\n    tool_name?: string;\n    tool_args?: string;\n    tool_result?: string;\n    is_error?: boolean;\n    history?: ChatMessage[];\n    tokens_before?: number; // For auto_compact events\n    tokens_after?: number;  // For auto_compact events\n}\n\nexport interface ContextItem {\n    path: string;\n    token_size: number;\n    content?: string;\n}\n\nexport interface ContextState {\n    items: ContextItem[];\n    total_tokens: number;\n    system_prompt?: string;\n}\n\nexport interface CompactRequest {\n    messages: ChatMessage[];\n    keep?: string;\n}\n\nexport interface CompactResponse {\n    messages: ChatMessage[];\n    tokens_before: number;\n    tokens_after: number;\n    warning?: string;\n}\n\nexport const agentApi = {\n    chat: async (request: ChatRequest): Promise\u003cChatResponse\u003e =\u003e {\n        return await apiClient.post\u003cChatResponse\u003e('/api/agent/chat', request);\n    },\n\n    getContext: async (includeContent: boolean = false): Promise\u003cContextState\u003e =\u003e {\n        const query = includeContent ? '?include_content=true' : '';\n        return await apiClient.get\u003cContextState\u003e(`/api/agent/context${query}`);\n    },\n\n    compact: async (request: CompactRequest): Promise\u003cCompactResponse\u003e =\u003e {\n        return await apiClient.post\u003cCompactResponse\u003e('/api/agent/compact', request);\n    },\n\n    // Streaming chat using EventSource pattern\n    chatStream: (\n        request: ChatRequest,\n        onEvent: (event: StreamEvent) =\u003e void,\n        onError: (error: Error) =\u003e void,\n        onComplete: () =\u003e void\n    ): AbortController =\u003e {\n        const controller = new AbortController();\n        const token = apiClient.getToken();\n\n        if (!token) {\n            onError(new Error('Not authenticated. Please log in.'));\n            return controller;\n        }\n\n        fetch(`${API_CONFIG.BACKEND_URL}/api/agent/chat/stream`, {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json',\n                'Authorization': `Bearer ${token}`,\n            },\n            body: JSON.stringify(request),\n            signal: controller.signal,\n        })\n            .then((response) =\u003e {\n                if (!response.ok) {\n                    throw new Error(`HTTP ${response.status}`);\n                }\n                const reader = response.body?.getReader();\n                if (!reader) {\n                    throw new Error('No reader available');\n                }\n\n                const decoder = new TextDecoder();\n                let buffer = '';\n\n                const processChunk = (chunk: string) =\u003e {\n                    buffer += chunk;\n                    const lines = buffer.split('\\n');\n                    buffer = lines.pop() || '';\n\n                    for (const line of lines) {\n                        if (line.startsWith('data:')) {\n                            const data = line.slice(5).trim();\n                            if (data) {\n                                try {\n                                    const event: StreamEvent = JSON.parse(data);\n                                    onEvent(event);\n                                } catch {\n                                    // Skip malformed JSON\n                                }\n                            }\n                        }\n                    }\n                };\n\n                const readStream = async () =\u003e {\n                    // eslint-disable-next-line no-constant-condition\n                    while (true) {\n                        const { done, value } = await reader.read();\n                        if (done) break;\n                        processChunk(decoder.decode(value, { stream: true }));\n                    }\n                    onComplete();\n                };\n\n                readStream().catch(onError);\n            })\n            .catch(onError);\n\n        return controller;\n    },\n};\n",
        "token_size": 1169
      },
      "/Users/qiliu/projects/nexuscrm/mcp/pkg/compactor/compactor.go": {
        "path": "/Users/qiliu/projects/nexuscrm/mcp/pkg/compactor/compactor.go",
        "content": "package compactor\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"os\"\n\t\"strings\"\n\t\"time\"\n\n\t\"github.com/nexuscrm/mcp/pkg/llm\"\n)\n\n// DefaultSummarizationModel is the default model used for summarization\nconst DefaultSummarizationModel = \"nvidia-nemotron-3-nano-30b-a3b-mlx\"\n\n// Compactor provides conversation history compaction services\ntype Compactor struct {\n\tllmClient llm.Client\n\tmodel     string\n}\n\n// NewCompactor creates a new Compactor instance\nfunc NewCompactor(llmClient llm.Client) *Compactor {\n\tmodel := DefaultSummarizationModel\n\tif val := os.Getenv(\"COMPACT_MODEL\"); val != \"\" {\n\t\tmodel = val\n\t}\n\treturn \u0026Compactor{\n\t\tllmClient: llmClient,\n\t\tmodel:     model,\n\t}\n}\n\n// EstimateTokens provides a rough token count for messages (4 chars ~= 1 token)\nfunc EstimateTokens(messages []llm.Message) int {\n\ttotal := 0\n\tfor _, msg := range messages {\n\t\ttotal += len(msg.Content) / 4\n\t\tfor _, tc := range msg.ToolCalls {\n\t\t\ttotal += len(tc.Function.Arguments) / 4\n\t\t}\n\t}\n\treturn total\n}\n\n// MaxToolResultLength is the maximum length for tool results before truncation\nconst MaxToolResultLength = 500\n\n// MicroCompact prunes verbose tool call arguments and results while preserving essential information.\n// This is a lightweight operation that doesn't require LLM calls.\nfunc MicroCompact(messages []llm.Message) []llm.Message {\n\tresult := make([]llm.Message, 0, len(messages))\n\n\tfor _, msg := range messages {\n\t\tnewMsg := llm.Message{\n\t\t\tRole:       msg.Role,\n\t\t\tContent:    msg.Content,\n\t\t\tName:       msg.Name,\n\t\t\tToolCallID: msg.ToolCallID,\n\t\t}\n\n\t\t// Prune tool call arguments (keep function name, truncate args)\n\t\tif len(msg.ToolCalls) \u003e 0 {\n\t\t\tnewMsg.ToolCalls = make([]llm.ToolCall, len(msg.ToolCalls))\n\t\t\tfor i, tc := range msg.ToolCalls {\n\t\t\t\t// Keep ID and function name, but truncate long arguments\n\t\t\t\targs := tc.Function.Arguments\n\t\t\t\tif len(args) \u003e MaxToolResultLength {\n\t\t\t\t\targs = args[:MaxToolResultLength] + \"...[truncated]\"\n\t\t\t\t}\n\t\t\t\tnewMsg.ToolCalls[i] = llm.ToolCall{\n\t\t\t\t\tID:   tc.ID,\n\t\t\t\t\tType: tc.Type,\n\t\t\t\t\tFunction: llm.FunctionCallData{\n\t\t\t\t\t\tName:      tc.Function.Name,\n\t\t\t\t\t\tArguments: args,\n\t\t\t\t\t},\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Prune tool result messages (truncate long results)\n\t\tif msg.Role == \"tool\" \u0026\u0026 len(msg.Content) \u003e MaxToolResultLength {\n\t\t\tnewMsg.Content = msg.Content[:MaxToolResultLength] + \"...[truncated]\"\n\t\t}\n\n\t\tresult = append(result, newMsg)\n\t}\n\n\treturn result\n}\n\n// Compact summarizes conversation history to reduce token usage\nfunc (c *Compactor) Compact(ctx context.Context, req CompactRequest) (*CompactResponse, error) {\n\t// Check for cancellation early\n\tselect {\n\tcase \u003c-ctx.Done():\n\t\treturn \u0026CompactResponse{\n\t\t\tMessages:     req.Messages,\n\t\t\tTokensBefore: EstimateTokens(req.Messages),\n\t\t\tTokensAfter:  EstimateTokens(req.Messages),\n\t\t}, ctx.Err()\n\tdefault:\n\t}\n\n\tmessages := req.Messages\n\n\t// Edge case: too few messages to compact\n\tif len(messages) \u003c 6 {\n\t\treturn \u0026CompactResponse{\n\t\t\tMessages:     messages,\n\t\t\tTokensBefore: EstimateTokens(messages),\n\t\t\tTokensAfter:  EstimateTokens(messages),\n\t\t}, nil\n\t}\n\n\ttokensBefore := EstimateTokens(messages)\n\n\t// Step 1: Identify System Prompt and Previous Summary\n\tvar baseSystemPrompt string\n\tvar previousSummary string\n\tsystemMsgIndex := -1\n\n\tfor i, msg := range messages {\n\t\tif msg.Role == \"system\" {\n\t\t\tsystemMsgIndex = i\n\t\t\t// Extract existing summary if present\n\t\t\tsummaryStart := strings.Index(msg.Content, \"--- CONVERSATION SUMMARY\")\n\t\t\tif summaryStart != -1 {\n\t\t\t\tsummaryEnd := strings.Index(msg.Content, \"--- END SUMMARY ---\")\n\t\t\t\tif summaryEnd != -1 {\n\t\t\t\t\t// Extract the summary content\n\t\t\t\t\theaderEnd := strings.Index(msg.Content[summaryStart:], \"---\\n\")\n\t\t\t\t\tif headerEnd != -1 {\n\t\t\t\t\t\tpreviousSummary = strings.TrimSpace(msg.Content[summaryStart+headerEnd+4 : summaryEnd])\n\t\t\t\t\t}\n\t\t\t\t\t// Base prompt is everything before the summary block\n\t\t\t\t\tbaseSystemPrompt = strings.TrimSpace(msg.Content[:summaryStart])\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tbaseSystemPrompt = msg.Content\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t}\n\n\t// Step 2: Identify Retention Cutoff (Keep last N turns active)\n\t// We want to keep at least the last 1-2 complete turns + current turn\n\t// A safe heuristic is to keep messages from the 2nd to last User message\n\tcutoffIndex := -1 // Default: Undefined\n\n\t// Scan backwards\n\tuserMsgCount := 0\n\tlastUserIndex := -1\n\tfor i := len(messages) - 1; i \u003e= 0; i-- {\n\t\tmsg := messages[i]\n\t\tif msg.Role == \"user\" {\n\t\t\tuserMsgCount++\n\t\t\tlastUserIndex = i\n\t\t\tif userMsgCount == 2 { // Keep last 2 user starts (current + previous)\n\t\t\t\tcutoffIndex = i\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}\n\n\t// Fallback: If we didn't find 2 user messages, keep from the last one found\n\tif cutoffIndex == -1 {\n\t\tif lastUserIndex != -1 {\n\t\t\tcutoffIndex = lastUserIndex\n\t\t} else {\n\t\t\t// No user messages? Keep everything to be safe\n\t\t\tcutoffIndex = 0\n\t\t\tif systemMsgIndex != -1 {\n\t\t\t\tcutoffIndex = systemMsgIndex + 1\n\t\t\t}\n\t\t}\n\t}\n\n\t// Safety check: Ensure we are actually compacting a meaningful amount of history\n\t// If cutoffIndex is too close to the system message, we're not splitting enough off to archive.\n\tif cutoffIndex \u003c= systemMsgIndex+1 {\n\t\t// Just return original if we can't meaningfully split\n\t\treturn \u0026CompactResponse{\n\t\t\tMessages:     messages,\n\t\t\tTokensBefore: tokensBefore,\n\t\t\tTokensAfter:  tokensBefore,\n\t\t}, nil\n\t}\n\n\t// Explicitly define what to summarize and what to keep\n\t// messagesToSummarize: everything AFTER system prompt UP TO cutoff\n\tvar messagesToSummarize []llm.Message\n\tif systemMsgIndex != -1 {\n\t\tif cutoffIndex \u003e systemMsgIndex+1 {\n\t\t\tmessagesToSummarize = messages[systemMsgIndex+1 : cutoffIndex]\n\t\t}\n\t} else {\n\t\tmessagesToSummarize = messages[:cutoffIndex]\n\t}\n\n\tactiveMessages := messages[cutoffIndex:]\n\n\t// Step 3: Apply MicroCompact ONLY to the archive messages (before summarization)\n\t// We don't want to MicroCompact active messages!\n\tprunedArchive := MicroCompact(messagesToSummarize)\n\n\t// Step 4: Build Text for Summarization\n\tvar historyBuilder strings.Builder\n\tfor _, msg := range prunedArchive {\n\t\thistoryBuilder.WriteString(fmt.Sprintf(\"[%s]: %s\\n\", msg.Role, msg.Content))\n\t\t// Include tool info for context\n\t\tif len(msg.ToolCalls) \u003e 0 {\n\t\t\tfor _, tc := range msg.ToolCalls {\n\t\t\t\thistoryBuilder.WriteString(fmt.Sprintf(\"(Tool Call: %s)\\n\", tc.Function.Name))\n\t\t\t}\n\t\t}\n\t\tif msg.Role == \"tool\" {\n\t\t\t// For tools, just mention it existed or give brief content if short\n\t\t\tif msg.Name != \"\" {\n\t\t\t\thistoryBuilder.WriteString(fmt.Sprintf(\"(Tool Result: %s)\\n\", msg.Name))\n\t\t\t} else {\n\t\t\t\thistoryBuilder.WriteString(\"(Tool Result)\\n\")\n\t\t\t}\n\t\t}\n\t}\n\n\t// Step 5: Call LLM\n\tkeepInstruction := \"\"\n\tif req.Keep != \"\" {\n\t\tkeepInstruction = fmt.Sprintf(\"\\n\\nIMPORTANT: Make sure to preserve details about: %s\", req.Keep)\n\t}\n\n\tpreviousSummarySection := \"\"\n\tif previousSummary != \"\" {\n\t\tpreviousSummarySection = fmt.Sprintf(`\nPrevious Context Summary (incorporate this into your new summary):\n%s\n\n`, previousSummary)\n\t}\n\n\tsummarizationPrompt := fmt.Sprintf(`Summarize the following conversation history concisely.\nThis history will be removed from the prompt, so capture ALL critical state, decisions, and code references.\n\n%s\n\n%sRecent Conversation to Archive:\n%s\n\nProvide a concise, consolidated summary (2-4 paragraphs). Focus on:\n- What has been accomplished\n- Function definitions or code snippets active in context\n- Errors encountered and resolutions\n`, keepInstruction, previousSummarySection, historyBuilder.String())\n\n\tllmReq := llm.Request{\n\t\tModel: c.model,\n\t\tMessages: []llm.Message{\n\t\t\t{Role: \"user\", Content: summarizationPrompt},\n\t\t},\n\t\tTemperature: 0.3,\n\t}\n\n\tresp, err := c.llmClient.Chat(ctx, llmReq)\n\tif err != nil {\n\t\treturn \u0026CompactResponse{\n\t\t\tMessages:     messages,\n\t\t\tTokensBefore: tokensBefore,\n\t\t\tTokensAfter:  tokensBefore,\n\t\t}, fmt.Errorf(\"summarization failed: %w\", err)\n\t}\n\n\tif len(resp.Choices) == 0 || resp.Choices[0].Message.Content == \"\" {\n\t\treturn \u0026CompactResponse{\n\t\t\tMessages:     messages,\n\t\t\tTokensBefore: tokensBefore,\n\t\t\tTokensAfter:  tokensBefore,\n\t\t}, fmt.Errorf(\"empty summarization response\")\n\t}\n\n\tnewSummary := resp.Choices[0].Message.Content\n\n\t// Step 6: Construct Final Messages\n\t// 1. New System Message (Base + New Summary)\n\t// 2. Verified Active Messages (Verbatim)\n\n\t// Calculate stats\n\tsummaryTokens := len(newSummary) / 4\n\trecentTokens := EstimateTokens(activeMessages)\n\testTokensAfter := summaryTokens + recentTokens // + system prompt overhead (constant-ish)\n\tsavedEst := tokensBefore - estTokensAfter\n\tif savedEst \u003c 0 {\n\t\tsavedEst = 0\n\t}\n\n\tcompactTime := time.Now()\n\tcompactedSystemContent := fmt.Sprintf(\"%s\\n\\n--- CONVERSATION SUMMARY (Saved ~%d tokens | Compacted: %s) ---\\n%s\\n--- END SUMMARY ---\", baseSystemPrompt, savedEst, compactTime.Format(\"Jan 2, 3:04 PM\"), newSummary)\n\n\tfinalMessages := []llm.Message{\n\t\t{Role: \"system\", Content: compactedSystemContent, Timestamp: \u0026compactTime},\n\t}\n\tfinalMessages = append(finalMessages, activeMessages...)\n\n\treturn \u0026CompactResponse{\n\t\tMessages:     finalMessages,\n\t\tTokensBefore: tokensBefore,\n\t\tTokensAfter:  EstimateTokens(finalMessages),\n\t}, nil\n}\n",
        "token_size": 2252
      }
    }
  }
}